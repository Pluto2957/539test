<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šå½©539 æ™ºèƒ½æ“ç›¤ç³»çµ± (Fixed v7.5)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --highlight: #e94560;
            --text-primary: #ecf0f1;
            --gold: #f1c40f;
            --hot: #e74c3c;
            --win: #00b894;
            --loss: #ff7675;
            --strategy: #0984e3;
            --sniper: #9b59b6; 
            --gray: #95a5a6;
        }

        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; padding: 20px; background-color: var(--bg-color); color: var(--text-primary); margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; display: grid; gap: 20px; }
        
        header { text-align: center; padding: 20px; background: var(--card-bg); border-radius: 15px; border-bottom: 4px solid var(--highlight); box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: relative; transition: border-color 0.3s; }
        h1 { margin: 0; color: var(--text-primary); font-size: 24px; }
        
        /* Mode Switcher */
        .mode-switcher { display: flex; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; justify-content: center; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; color: #7f8c8d; background: #2c3e50; transition: 0.3s; text-align: center; border: 2px solid transparent; }
        .mode-btn.active { color: white; background: var(--highlight); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .mode-btn:hover { opacity: 0.9; }
        
        /* Mode B Specifics */
        body.mode-b header { border-bottom-color: var(--sniper); }
        body.mode-b .mode-btn.active { background: var(--sniper); }
        body.mode-b .card h2 { border-left-color: var(--sniper); }
        body.mode-b .btn-fetch { background: var(--sniper); }
        
        .status-bar { background: #2c3e50; padding: 10px; border-radius: 8px; text-align: center; font-size: 14px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .loading { color: var(--gold); animation: blink 1.5s infinite; }
        .success { color: #2ecc71; font-weight: bold; }
        .syncing { color: #3498db; font-weight: bold; }

        /* Data Range Info in Status Bar */
        .data-range-info { font-size: 12px; color: #95a5a6; margin-right: 5px; }
        .data-count-highlight { color: #ecf0f1; font-weight: bold; }

        /* Reset Button Area */
        .tools-area { text-align: right; margin-bottom: 10px; }
        .btn-reset { background: #c0392b; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.3s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-reset:hover { background: #e74c3c; box-shadow: 0 0 10px rgba(231, 76, 60, 0.4); }
        .btn-reset:disabled { opacity: 0.5; cursor: not-allowed; }

        .dashboard { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 900px) { .dashboard { grid-template-columns: 1fr 1fr; } }

        .card { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
        .card h2 { margin-top: 0; font-size: 18px; border-left: 4px solid var(--highlight); padding-left: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: border-color 0.3s; }
        .card-tag { font-size: 12px; background: #333; padding: 2px 8px; border-radius: 4px; color: #aaa; }

        /* Strategy Control */
        .strategy-control-panel { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
        .control-row { display: flex; gap: 10px; align-items: center; }
        .strategy-select { flex-grow: 2; padding: 8px; border-radius: 4px; background: #2c3e50; color: white; border: 1px solid #444; }
        
        .unit-input-group { display: flex; align-items: center; gap: 5px; flex-grow: 1; }
        .unit-label { font-size: 13px; color: #bdc3c7; white-space: nowrap; }
        .unit-input { width: 60px; padding: 8px; border-radius: 4px; background: #2c3e50; color: var(--gold); border: 1px solid #444; text-align: center; font-weight: bold; }

        .btn-switch { background: #34495e; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .btn-switch:hover { background: #2c3e50; }

        /* Loading */
        .progress-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(22, 33, 62, 0.9); z-index: 10; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .progress-bar-bg { width: 80%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-bar-fill { height: 100%; background: var(--highlight); width: 0%; transition: width 0.3s; }

        /* Strategy Stats Grid */
        .strategy-box { background: rgba(9, 132, 227, 0.1); border: 1px solid var(--strategy); border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: all 0.3s; }
        .strategy-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; text-align: center; }
        @media(max-width: 600px) { .strategy-grid { grid-template-columns: 1fr 1fr; } }
        
        .stat-item { background: #24344d; padding: 8px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; }
        .stat-label { font-size: 11px; color: #95a5a6; }
        .stat-value { font-size: 16px; font-weight: bold; margin-top: 3px; }
        .val-win { color: var(--win); }
        .val-loss { color: var(--loss); }

        /* Signal Lights */
        .signal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .signal-btn { padding: 12px; border-radius: 8px; text-align: center; font-size: 14px; font-weight: bold; background: #2c3e50; color: #7f8c8d; border: 1px solid #34495e; opacity: 0.4; transition: 0.3s; }
        .signal-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 10px rgba(0,0,0,0.5); border: 2px solid white; }
        .sig-super.active { background: linear-gradient(135deg, #e17055, #d63031); color: white; }
        .sig-strong.active { background: linear-gradient(135deg, #00b894, #0984e3); color: white; }
        .sig-weak.active { background: #636e72; color: #dfe6e9; }
        .sig-stop.active { background: #2d3436; color: #ff7675; }

        /* Sniper Balls */
        .sniper-balls { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .s-ball-box { text-align: center; }
        .s-ball { width: 60px; height: 60px; line-height: 60px; border-radius: 50%; font-size: 24px; font-weight: bold; background: radial-gradient(circle at 30% 30%, #9b59b6, #8e44ad); color: white; box-shadow: 0 4px 15px rgba(142, 68, 173, 0.5); margin: 0 auto; border: 2px solid #a569bd; }
        .s-label { font-size: 12px; color: #bdc3c7; margin-top: 5px; }

        /* Full History Table */
        .full-history-card { grid-column: 1 / -1; }
        .history-table-container { overflow-x: auto; }
        .full-history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; white-space: nowrap; }
        .full-history-table th { background: #24344d; padding: 12px 8px; color: #bdc3c7; text-align: center; border-bottom: 2px solid #1a1a2e; }
        .full-history-table td { padding: 10px 8px; border-bottom: 1px solid #333; text-align: center; color: #ecf0f1; }
        .full-history-table tr:hover { background: rgba(255,255,255,0.02); }
        
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; align-items: center; }
        .page-btn { background: #34495e; color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .page-btn:hover:not(:disabled) { background: var(--strategy); }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .page-info { font-size: 13px; color: #95a5a6; }

        .num-ball { display: inline-block; width: 22px; height: 22px; line-height: 22px; border-radius: 50%; text-align: center; font-size: 12px; margin: 0 1px; color: #7f8c8d; background: #222; }
        .num-hit-0 { background: #ff7675; color: white; font-weight: bold; } /* 0é ­å‘½ä¸­ */
        .num-hit-1 { background: #f1c40f; color: #222; font-weight: bold; } /* ç†±1å‘½ä¸­ */
        .num-hit-2 { background: #0984e3; color: white; font-weight: bold; } /* ç†±2å‘½ä¸­ */
        
        .res-badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-win { background: rgba(0, 184, 148, 0.2); color: var(--win); border: 1px solid var(--win); }
        .badge-loss { background: rgba(255, 118, 117, 0.1); color: var(--loss); opacity: 0.8; }

        .btn-fetch { background: var(--strategy); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; }
        .btn-fetch:hover { opacity: 0.9; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #manualInputSection { display: none; margin-top: 10px; padding: 15px; background: #c0392b; border-radius: 8px; text-align: center; }
        .manual-input { width: 40px; padding: 5px; text-align: center; margin: 0 2px; }
        .last-bet-info { text-align: center; font-size: 13px; color: #95a5a6; margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 20px; }

        /* Chart Canvas Container */
        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 10px; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="mode-a">

<div class="container">
    <header>
        <h1 id="app-title">ğŸ”¥ ä»Šå½©539 æ™ºèƒ½æ“ç›¤ç³»çµ± (Pro Chart)</h1>
    </header>

    <div class="mode-switcher">
        <button class="mode-btn active" id="btnModeA" onclick="setMode('A')">ç©æ³• Aï¼šè°æ˜åŒ…ç‰Œ (0é ­)</button>
        <button class="mode-btn" id="btnModeB" onclick="setMode('B')">ç©æ³• Bï¼šç²¾æº–ç¨æ”¯ (Sniper-6)</button>
    </div>

    <div class="status-bar">
        <span id="statusText" class="loading">â³ ç³»çµ±å•Ÿå‹•ä¸­...</span>
        <span id="dataCount" style="color:#bdc3c7;"></span>
    </div>

    <div class="tools-area">
        <button class="btn-reset" onclick="resetAndReloadData()" id="btnResetData">
            ğŸ”„ é‡æ–°é©—è­‰æ•¸æ“š (Reset Data)
        </button>
    </div>

    <div id="manualInputSection">
        <p style="color:white; font-weight:bold;">âš ï¸ è‡ªå‹•æ›´æ–°å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æœ€æ–°ä¸€æœŸè™Ÿç¢¼ï¼š</p>
        <input type="number" class="manual-input" id="m1"><input type="number" class="manual-input" id="m2"><input type="number" class="manual-input" id="m3"><input type="number" class="manual-input" id="m4"><input type="number" class="manual-input" id="m5">
        <button onclick="manualStart()" style="padding:5px 15px; cursor:pointer;">ç¢ºèª</button>
    </div>

    <div class="dashboard">
        <div class="card" id="card-backtest">
            <h2>ğŸ’° ç­–ç•¥å›æ¸¬å ±å‘Š <span class="card-tag" id="current-strategy-tag">New Sniper</span></h2>
            
            <div class="strategy-control-panel">
                <div class="control-row">
                    <select id="strategySelect" class="strategy-select">
                        </select>
                </div>
                <div class="control-row">
                    <div class="unit-input-group">
                        <span class="unit-label">åŸºæœ¬å–®ä½:</span>
                        <input type="number" id="baseUnit" class="unit-input" value="1" min="1">
                    </div>
                    <button class="btn-switch" onclick="runAnalysisWithLoading()">ç¢ºå®šåˆ‡æ›</button>
                </div>
            </div>

            <div class="progress-overlay" id="loadingBar">
                <div style="color:white; font-weight:bold;">ç­–ç•¥é‹ç®—ä¸­...</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
            </div>
            
            <div class="strategy-box" id="strategyBox">
                <div class="strategy-title">
                    ğŸ“Š æ­·å²ç¸¾æ•ˆ (å…± <span id="real-test-count-disp" style="color:var(--highlight); margin:0 5px;">--</span> æœŸ)
                </div>
                <div class="strategy-grid">
                    <div class="stat-item">
                        <div class="stat-label">ç´¯ç©æ·¨åˆ© (Net)</div>
                        <div class="stat-value val-win" id="st-profit">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æŠ•è³‡å ±é…¬ç‡ (ROI)</div>
                        <div class="stat-value val-win" id="st-roi">--%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å‹ç‡ (Win Rate)</div>
                        <div class="stat-value" id="st-winrate">--%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ç¸½ä¸‹æ³¨å–®æ•¸</div>
                        <div class="stat-value" id="st-count" style="color:#e94560;">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€é«˜é€£å‹</div>
                        <div class="stat-value val-win" id="st-max-win">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€é«˜é€£æ•—</div>
                        <div class="stat-value val-loss" id="st-max-loss">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€å¤§å›æ’¤ (MDD)</div>
                        <div class="stat-value val-loss" id="st-mdd">--</div>
                    </div>
                    <div class="stat-item" style="opacity:0.5;">
                         <div class="stat-label">è¨­å®šå–®ä½</div>
                         <div class="stat-value" id="st-unit">1</div>
                    </div>
                </div>
                <div id="strategy-desc" style="font-size:12px; color:#95a5a6; margin-top:10px; padding-top:10px; border-top:1px dashed #555;">
                    --
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ”® ä¸‹ä¸€æœŸæ“ç›¤å»ºè­° <span class="card-tag">Signal</span></h2>
            
            <div class="last-bet-info">
                ğŸ“… æœ€å¾Œä¸€æ¬¡é€²å ´: <span id="last-bet-date" style="color:var(--highlight); font-weight:bold;">--/--</span>
            </div>

            <div style="text-align:center; padding:10px 0;">
                <div style="font-size:14px; color:#bdc3c7; margin-bottom:5px;">ä¸‹ä¸€æœŸé–‹çæ—¥</div>
                <div id="nextDrawDate" style="font-size:20px; font-weight:bold; color:var(--text-primary);">--/--</div>
                <div id="nextWeekday" style="font-size:16px; color:var(--highlight); margin-top:2px; font-weight:bold;">é€±--</div>
            </div>

            <div id="prediction-panel">
                <div id="panel-mode-a" style="display:block;">
                    <div class="signal-grid">
                        <div id="btn-super" class="signal-btn sig-super">ğŸ”¥ å¼·åŠ›è¨Šè™Ÿ<br><span style="font-size:10px; font-weight:normal;">2å€ / ç¿»å€</span></div>
                        <div id="btn-strong" class="signal-btn sig-strong">âš¡ é›™é‚Šè¨Šè™Ÿ<br><span style="font-size:10px; font-weight:normal;">P1 & P2</span></div>
                        <div id="btn-weak" class="signal-btn sig-weak">â„ï¸ æ¨™æº–è¨Šè™Ÿ<br><span style="font-size:10px; font-weight:normal;">1å€ P1</span></div>
                        <div id="btn-stop" class="signal-btn sig-stop">ğŸ›‘ æš«åœ/é¢¨éšª<br><span style="font-size:10px; font-weight:normal;">æ¿¾ç¶²æœªé</span></div>
                    </div>
                    <div class="strategy-box" style="border-color:#555; background:rgba(255,255,255,0.05);">
                        <div class="strategy-title" style="color:#ddd; justify-content:center;">
                            æ¨è–¦çµ„åˆ (Package)
                        </div>
                        <div style="text-align:center; margin-top:10px;">
                            <div style="font-size:18px; font-weight:bold; color:var(--gold);" id="pred-combo">--</div>
                            <div style="font-size:12px; color:#7f8c8d; margin-top:5px;" id="pred-desc">--</div>
                        </div>
                    </div>
                </div>

                <div id="panel-mode-b" style="display:none;">
                    <div id="sniper-status" style="text-align:center; font-size:16px; font-weight:bold; margin-bottom:15px; color:#bdc3c7;">
                        æª¢æ¸¬è¨Šè™Ÿä¸­...
                    </div>
                    <div class="sniper-balls" id="sniper-balls-container" style="display:none;">
                        <div class="s-ball-box">
                            <div class="s-ball" id="ball-1">--</div>
                            <div class="s-label">ç¬¬ä¸€ç†±é–€</div>
                        </div>
                        <div class="s-ball-box">
                            <div class="s-ball" id="ball-2">--</div>
                            <div class="s-label">ç¬¬äºŒç†±é–€</div>
                        </div>
                    </div>
                    <div class="strategy-box" style="border-color:var(--sniper); background:rgba(142, 68, 173, 0.1);">
                         <div style="text-align:center; font-size:14px; color:#ddd;">
                             ğŸ¯ <b>Sniper-6 ç­–ç•¥è¦å‰‡ (Original)</b><br>
                             <span style="font-size:12px; color:#aaa;">è¿‘15æœŸæ¦œé¦–å‰›å¥½å‡ºç¾6æ¬¡ â¡ é€²å ´è²·å‰2ç†±</span><br>
                             <span style="font-size:12px; color:#aaa; margin-top:5px; display:inline-block;">æˆæœ¬: $5,700 / çé‡‘: $21,200</span>
                         </div>
                    </div>
                </div>
            </div>
            
            <button id="btnFetch" class="btn-fetch" onclick="forceFetchData()">
                <span id="fetchIcon">ğŸ”„</span> 
                <span id="fetchText">æ‰‹å‹•æŠ“å–æœ€æ–°æ•¸æ“š</span>
            </button>
        </div>
        
        <div class="card full-history-card">
            <h2>ğŸ“œ è©³ç´°ä¸‹æ³¨æ­·å²ç´€éŒ„ <span class="card-tag">Full History</span></h2>
            <div class="history-table-container">
                <table class="full-history-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é–‹çè™Ÿç¢¼</th>
                            <th>è¨Šè™Ÿ/é æ¸¬</th>
                            <th>ä¸‹æ³¨é‡‘é¡</th>
                            <th>æ·¨æç›Š</th>
                            <th>çµæœ</th>
                        </tr>
                    </thead>
                    <tbody id="fullHistoryBody">
                        </tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="page-btn" onclick="changePage(-1)">â—€ ä¸Šä¸€é </button>
                <span class="page-info" id="pageInfo">ç¬¬ 1 / 1 é </span>
                <button class="page-btn" onclick="changePage(1)">ä¸‹ä¸€é  â–¶</button>
            </div>
        </div>
        
        <div class="card" style="grid-column: 1 / -1;">
            <h2>ğŸ“ˆ è³‡é‡‘æ¬Šç›Šèµ°å‹¢åœ– <span class="card-tag">Equity Curve</span></h2>
            <div class="chart-container">
                <canvas id="equityChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        // ==========================================
        //  è¨­å®šå€ï¼šæ‚¨çš„ Google Drive æª”æ¡ˆ ID
        // ==========================================
        const DRIVE_FILE_ID = '1K2CNRIE97NRfJrzKiG8Adcz_tFeYHPlm';
        
        // æ ¸å¿ƒåƒæ•¸
        let fullData = [];
        let currentMode = 'A'; 
        let currentStrategyA = 'sniper_new'; 
        let globalTradeHistory = []; 
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;
        
        const STORAGE_KEY = 'lotto539_data_cache_v8_cloud'; 
        const CRAWL_PAGES = 3; 
        const BASE_URL = "https://www.lotto-8.com/listlto539.asp";
        
        const COST_PER_BET_A = 1062;
        const PRIZE_3 = 1710;
        const PRIZE_4 = 2280;
        
        const COST_PER_BET_B = 5700; 
        const PRIZE_B = 21200;

        const HEADS = {
            0: [1,2,3,4,5,6,7,8,9],
            1: [11,12,13,14,15,16,17,18,19],
            2: [21,22,23,24,25,26,27,28,29],
            3: [31,32,33,34,35,36,37,38,39]
        };
        
        // Chart Instance
        let equityChartInstance = null;

        window.onload = initSystem;

        // å¾é›²ç«¯ä¸‹è¼‰æ­·å²æ•¸æ“š
        async function fetchCloudData() {
            const status = document.getElementById('statusText');
            status.innerText = "â˜ï¸ æ­£åœ¨ä¸‹è¼‰é›²ç«¯æ­·å²æ•¸æ“š...";
            status.className = "syncing";

            const driveUrl = `https://drive.google.com/uc?export=download&id=${DRIVE_FILE_ID}`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(driveUrl)}`;

            try {
                let res = await fetch(proxyUrl);
                if (!res.ok) throw new Error("Network response was not ok");
                let data = await res.json();
                console.log("é›²ç«¯æ•¸æ“šä¸‹è¼‰æˆåŠŸï¼Œå…±", data.length, "ç­†");
                return data;
            } catch (error) {
                console.error("é›²ç«¯ä¸‹è¼‰å¤±æ•—:", error);
                status.innerText = "âš ï¸ é›²ç«¯ä¸‹è¼‰å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°/çˆ¬èŸ²";
                return []; 
            }
        }

        async function initSystem() {
            let cloudData = await fetchCloudData();
            
            let localData = [];
            const localStr = localStorage.getItem(STORAGE_KEY);
            if (localStr) {
                try { localData = JSON.parse(localStr); } catch(e) {}
            }

            let mergedMap = new Map();
            if (Array.isArray(cloudData)) cloudData.forEach(item => mergedMap.set(item.date, item));
            if (Array.isArray(localData)) localData.forEach(item => mergedMap.set(item.date, item));

            fullData = Array.from(mergedMap.values());
            fullData.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
            
            updateStrategyOptions(); 
            runAnalysisWithLoading();

            await forceFetchData(); 
        }

        // ==========================================
        //  RESET DATA FUNCTION
        // ==========================================
        async function resetAndReloadData() {
            if (!confirm("âš ï¸ ç¢ºå®šè¦åŸ·è¡Œã€Œé‡æ–°é©—è­‰ã€å—ï¼Ÿ\n\né€™å°‡æœƒï¼š\n1. åˆªé™¤ç€è¦½å™¨æš«å­˜çš„èˆŠè³‡æ–™\n2. é‡æ–°å¾é›²ç«¯ä¸‹è¼‰æ­·å²æª”æ¡ˆ\n3. è‡ªå‹•çˆ¬èŸ²è£œé½Šæœ€æ–°é–‹çæ—¥\n\n(è‹¥ç¶²è·¯ä¸ç©©å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“)")) {
                return;
            }

            const btn = document.getElementById('btnResetData');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "â³ æ­£åœ¨é‡ç½®èˆ‡ä¸‹è¼‰...";
            
            const status = document.getElementById('statusText');
            status.innerText = "â™»ï¸ æ¸…é™¤å¿«å–ä¸¦é‡æ–°åŒæ­¥ä¸­...";
            status.className = "syncing";

            try {
                // 1. Clear Local Storage
                localStorage.removeItem(STORAGE_KEY);
                fullData = []; // Clear memory

                // 2. Fetch from Cloud
                let cloudData = await fetchCloudData();

                // 3. Update Memory & Storage
                let mergedMap = new Map();
                if (Array.isArray(cloudData)) {
                    cloudData.forEach(item => mergedMap.set(item.date, item));
                }
                
                fullData = Array.from(mergedMap.values());
                fullData.sort((a,b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));

                // 4. Update UI
                runAnalysisWithLoading();

                // 5. Trigger Crawler
                await forceFetchData();

                alert("âœ… æ•¸æ“šé‡ç½®èˆ‡æ›´æ–°å®Œæˆï¼");

            } catch (e) {
                console.error(e);
                alert("âŒ é‡ç½®éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥ã€‚");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function forceFetchData() {
            const btn = document.getElementById('btnFetch');
            const status = document.getElementById('statusText');

            if(btn) {
                btn.disabled = true;
                btn.querySelector('#fetchText').innerText = "è‡ªå‹•æ›´æ–°ä¸­...";
                btn.querySelector('#fetchIcon').classList.add('spin');
            }
            status.innerText = "ğŸ“¡ èƒŒæ™¯åŒæ­¥æ–°è³‡æ–™...";
            status.className = "syncing";

            const proxies = [
                url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&timestamp=${Date.now()}`,
                url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];

            let latestDate = (fullData.length > 0) ? fullData[0].date : "2000/01/01";
            let newData = [];
            let stop = false;

            try {
                for (let i = 1; i <= CRAWL_PAGES; i++) {
                    if (stop) break;
                    let targetUrl = i === 1 ? BASE_URL : `${BASE_URL}?indexpage=${i}&orderby=new`;
                    let html = null;

                    for (let attempt = 0; attempt < 3; attempt++) {
                        for (let proxy of proxies) {
                            try {
                                let res = await fetch(proxy(targetUrl));
                                let content = res.url.includes("allorigins") ? (await res.json()).contents : await res.text();
                                if (content && content.length > 500) { html = content; break; }
                            } catch(e) {}
                        }
                        if (html) break;
                        await new Promise(r => setTimeout(r, 1000));
                    }

                    if (html) {
                        let parsed = parseHtml(html);
                        for (let row of parsed) {
                            if (new Date(row.date) > new Date(latestDate)) {
                                newData.push(row);
                            } else {
                                stop = true; 
                            }
                        }
                    }
                }

                if (newData.length > 0) {
                    fullData = [...newData, ...fullData];
                    fullData.sort((a,b) => new Date(b.date) - new Date(a.date));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
                    status.innerText = `âœ… å·²æ›´æ–° ${newData.length} ç­†æ–°è³‡æ–™`;
                    status.className = "success";
                    runAnalysisWithLoading(); 
                } else {
                    status.innerText = "âœ… è³‡æ–™å·²æ˜¯æœ€æ–°";
                    status.className = "success";
                }

            } catch (e) {
                status.innerText = "âš ï¸ é€£ç·šé€¾æ™‚ (ä½¿ç”¨å¿«å–/é›²ç«¯)";
                status.className = "loading";
            }

            if(btn) {
                btn.disabled = false;
                btn.querySelector('#fetchText').innerText = "æ‰‹å‹•å¼·åˆ¶æ›´æ–°";
                btn.querySelector('#fetchIcon').classList.remove('spin');
            }
        }

        function parseHtml(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            let results = [];
            doc.querySelectorAll("tr").forEach(row => {
                const text = row.innerText.trim();
                const dMatch = text.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
                if (dMatch) {
                    let nums = text.match(/\d{2}/g);
                    if (nums && nums.length >= 5) {
                        let valid = [];
                        for (let i = nums.length - 1; i >= 0; i--) {
                            let n = parseInt(nums[i]);
                            if (n >= 1 && n <= 39 && !valid.includes(n)) valid.unshift(n);
                            if (valid.length === 5) break;
                        }
                        let dateStr = `${dMatch[1]}/${dMatch[2].padStart(2, '0')}/${dMatch[3].padStart(2, '0')}`;
                        if (valid.length === 5) results.push({ date: dateStr, numbers: valid });
                    }
                }
            });
            return results;
        }

        function manualStart() {
            let inputs = [1,2,3,4,5].map(i => parseInt(document.getElementById('m'+i).value));
            if(inputs.some(isNaN)) return alert("è«‹è¼¸å…¥å®Œæ•´è™Ÿç¢¼");
            
            let today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
            fullData.unshift({ date: today, numbers: inputs });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
            document.getElementById('manualInputSection').style.display = 'none';
            runAnalysisWithLoading();
        }

        function setMode(mode) {
            currentMode = mode;
            document.body.className = mode === 'A' ? 'mode-a' : 'mode-b';
            document.getElementById('btnModeA').className = mode === 'A' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btnModeB').className = mode === 'B' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('panel-mode-a').style.display = mode === 'A' ? 'block' : 'none';
            document.getElementById('panel-mode-b').style.display = mode === 'B' ? 'block' : 'none';
            
            updateStrategyOptions();
            runAnalysisWithLoading();
        }

        function updateStrategyOptions() {
            const select = document.getElementById('strategySelect');
            select.innerHTML = '';
            if (currentMode === 'A') {
                const opts = [
                    {val: 'sniper_new', text: '1. ğŸ¥‡ ç¥å°„æ‰‹ (New Sniper)'},
                    {val: 'shield_new', text: '2. ğŸ›¡ï¸ å …ç›¾é˜²ç¦¦ (New Shield)'},
                    {val: 'peak_martingale', text: '3. ğŸ’€ æ¥µé™å‡¹å–® (Peak Martingale)'}
                ];
                opts.forEach(o => {
                    let el = document.createElement('option');
                    el.value = o.val; el.text = o.text;
                    select.add(el);
                });
                select.value = currentStrategyA;
                select.disabled = false;
            } else {
                let el = document.createElement('option');
                el.value = 'sniper'; el.text = 'Sniper-6 ç²¾æº–ç¨æ”¯ (Original)';
                select.add(el);
                select.disabled = true;
            }
        }

        function runAnalysisWithLoading() {
            const loading = document.getElementById('loadingBar');
            const fill = document.getElementById('progressFill');
            const select = document.getElementById('strategySelect');
            
            if (currentMode === 'A') currentStrategyA = select.value;
            
            loading.style.display = 'flex';
            fill.style.width = '0%';
            
            setTimeout(() => { fill.style.width = '60%'; }, 200);
            
            setTimeout(() => { 
                fill.style.width = '100%';
                
                // UPDATE DATA RANGE DISPLAY
                if (fullData.length > 0) {
                    const firstDate = fullData[fullData.length - 1].date;
                    const lastDate = fullData[0].date;
                    document.getElementById('dataCount').innerHTML = 
                        `<span class="data-range-info">${firstDate} ~ ${lastDate}</span> <span class="data-count-highlight">(åº«å­˜: ${fullData.length} æœŸ)</span>`;
                } else {
                    document.getElementById('dataCount').innerText = '(ç„¡æ•¸æ“š)';
                }
                
                const unit = parseFloat(document.getElementById('baseUnit').value) || 1;
                
                // === FIXED: RESTORED PREDICTION CALL ===
                predictNextDraw(); 
                
                let res;
                if (currentMode === 'A') {
                    res = runPackageBacktest(fullData, currentStrategyA, unit);
                } else {
                    res = runSniperBacktest(fullData, unit);
                }
                
                updateStatBox(res);
                currentPage = 1;
                renderFullHistoryTable();
                
                updateEquityChart();
                
                if (currentMode === 'A') {
                    const tagName = select.options[select.selectedIndex].text.split('(')[1].split(')')[0];
                    document.getElementById('current-strategy-tag').innerText = tagName;
                } else {
                    document.getElementById('current-strategy-tag').innerText = "Sniper-6 (Original)";
                }
                
                setTimeout(() => { loading.style.display = 'none'; }, 200);
            }, 500);
        }

        function runPackageBacktest(data, strategy, baseUnit) {
            let totalCost = 0, totalPrize = 0;
            let winDays = 0, tradingDays = 0, totalBetUnits = 0;
            let currentWin = 0, maxWin = 0, currentLoss = 0, maxLoss = 0;
            let currentEquity = 0, peakEquity = 0, maxDrawdown = 0;
            let lastBetDate = "ç„¡";
            
            let peakMartingaleMult = 1;
            let lastTradeWon = false; 

            globalTradeHistory = []; 

            if(data.length < 22) return { cost: 0, net: 0, winDays: 0, tradingDays: 0, totalBetUnits:0, maxWin:0, maxLoss:0, maxDrawdown:0 };

            for(let i = data.length - 21; i >= 0; i--) {
                let targetDraw = data[i]; 
                let past20 = data.slice(i+1, i+21);
                let counts = getHeadCounts(past20);
                
                let others = {1: counts[1], 2: counts[2], 3: counts[3]};
                let sortedHeads = Object.keys(others).sort((a,b) => others[b] - others[a]);
                let p1 = parseInt(sortedHeads[0]);
                let p2 = parseInt(sortedHeads[1]);
                let gap = others[p1] - others[p2];
                let count0 = counts[0];
                
                let date = new Date(targetDraw.date);
                let day = date.getDay(); 
                
                let isTradeDay = false;

                if (strategy === 'sniper_new' || strategy === 'peak_martingale') {
                    isTradeDay = (day !== 2 && count0 <= 25);
                } else if (strategy === 'shield_new') {
                    isTradeDay = (day !== 2 && day !== 3 && count0 <= 22);
                }
                
                let betUnits = 0; 
                let dailyPrize = 0;
                let signalText = "";
                let isWin = false;

                if (isTradeDay) {
                    if (strategy === 'peak_martingale') {
                        if (currentEquity >= peakEquity) {
                            peakMartingaleMult = 1; 
                        } else {
                            if (!lastTradeWon) {
                                peakMartingaleMult = Math.min(peakMartingaleMult * 2, 16);
                            } 
                        }

                        betUnits = peakMartingaleMult;
                        let cost = betUnits * COST_PER_BET_A * baseUnit;
                        let prize = checkPrizeA(targetDraw.numbers, 0, p1) * betUnits * baseUnit;
                        
                        totalCost += cost;
                        dailyPrize += prize;
                        signalText = `0+${p1} (${peakMartingaleMult}å€)`;
                        
                        isWin = prize > cost;
                        lastTradeWon = isWin;

                    } else {
                        if (gap >= 6) {
                            betUnits = 2; 
                            dailyPrize += checkPrizeA(targetDraw.numbers, 0, p1) * 2 * baseUnit;
                            signalText = `0+${p1} (x2)`;
                        } else if (gap <= 2) {
                            betUnits = 2; 
                            dailyPrize += checkPrizeA(targetDraw.numbers, 0, p1) * baseUnit;
                            dailyPrize += checkPrizeA(targetDraw.numbers, 0, p2) * baseUnit;
                            signalText = `0+${p1}&${p2}`;
                        } else {
                            betUnits = 1; 
                            dailyPrize += checkPrizeA(targetDraw.numbers, 0, p1) * baseUnit;
                            signalText = `0+${p1}`;
                        }
                        let cost = betUnits * COST_PER_BET_A * baseUnit;
                        totalCost += cost;
                        isWin = dailyPrize > cost;
                    }

                    tradingDays++;
                    totalBetUnits += betUnits; 
                    totalPrize += dailyPrize;

                    let costThisRound = (strategy === 'peak_martingale') ? (peakMartingaleMult * COST_PER_BET_A * baseUnit) : (betUnits * COST_PER_BET_A * baseUnit);
                    currentEquity += (dailyPrize - costThisRound);
                    
                    if(currentEquity > peakEquity) peakEquity = currentEquity;
                    let dd = currentEquity - peakEquity;
                    if(dd < maxDrawdown) maxDrawdown = dd;
                    
                    if (isWin) {
                        winDays++;
                        currentWin++;
                        currentLoss = 0;
                        if(currentWin > maxWin) maxWin = currentWin;
                    } else {
                        currentLoss++;
                        currentWin = 0;
                        if(currentLoss > maxLoss) maxLoss = currentLoss;
                    }
                    lastBetDate = targetDraw.date;

                    globalTradeHistory.push({
                        date: targetDraw.date,
                        numbers: targetDraw.numbers,
                        signal: signalText,
                        cost: costThisRound,
                        net: dailyPrize - costThisRound,
                        isWin: isWin,
                        heads: {p1, p2} 
                    });
                }
            }
            
            globalTradeHistory.reverse();

            document.getElementById('last-bet-date').innerText = lastBetDate;
            let desc = "";
            if(strategy==='sniper_new') desc = "Sniper: é¿é€±äºŒï¼ŒGap>=6é‡æ³¨ï¼Œ<=2é›™é¾ã€‚";
            if(strategy==='shield_new') desc = "Shield: é¿é€±äºŒä¸‰ï¼Œåš´æ ¼éç†±æ¿¾ç¶²ã€‚";
            if(strategy==='peak_martingale') desc = "Peak: è³‡é‡‘å‰µé«˜å‰ï¼Œè¼¸å‰‡ç¿»å€è´å‰‡è¿½æ“Šã€‚";
            document.getElementById('strategy-desc').innerText = desc;

            return { cost: totalCost, net: totalPrize - totalCost, winDays, tradingDays, totalBetUnits, maxWin, maxLoss, maxDrawdown };
        }

        function runSniperBacktest(data, baseUnit) {
            let totalCost = 0, totalPrize = 0;
            let winDays = 0, tradingDays = 0, totalBetUnits = 0;
            let currentWin = 0, maxWin = 0, currentLoss = 0, maxLoss = 0;
            let currentEquity = 0, peakEquity = 0, maxDrawdown = 0;
            let lastBetDate = "ç„¡";
            
            globalTradeHistory = [];

            if(data.length < 16) return { cost: 0, net: 0, winDays: 0, tradingDays: 0, totalBetUnits:0, maxWin:0, maxLoss:0, maxDrawdown:0 };

            for(let i = data.length - 16; i >= 0; i--) {
                let targetDraw = data[i];
                let past15 = data.slice(i+1, i+16);
                
                let numCounts = {};
                for(let k=1; k<=39; k++) numCounts[k] = 0;
                past15.forEach(d => {
                    d.numbers.forEach(n => numCounts[n]++);
                });
                
                let sortedNums = Object.keys(numCounts).sort((a,b) => {
                    let diff = numCounts[b] - numCounts[a];
                    if (diff !== 0) return diff;
                    return parseInt(a) - parseInt(b); 
                });
                
                let top1 = parseInt(sortedNums[0]);
                let top2 = parseInt(sortedNums[1]);
                let top1_count = numCounts[top1];

                if (top1_count === 6) {
                    tradingDays++;
                    totalBetUnits += 2; 
                    
                    let cost = COST_PER_BET_B * baseUnit; 
                    let dailyPrize = 0;
                    
                    if (targetDraw.numbers.includes(top1)) dailyPrize += PRIZE_B * baseUnit;
                    if (targetDraw.numbers.includes(top2)) dailyPrize += PRIZE_B * baseUnit;
                    
                    totalCost += cost;
                    totalPrize += dailyPrize;

                    currentEquity += (dailyPrize - cost);
                    if(currentEquity > peakEquity) peakEquity = currentEquity;
                    let dd = currentEquity - peakEquity;
                    if(dd < maxDrawdown) maxDrawdown = dd;
                    
                    let isWin = dailyPrize > cost;

                    if (isWin) {
                        winDays++;
                        currentWin++;
                        currentLoss = 0;
                        if(currentWin > maxWin) maxWin = currentWin;
                    } else {
                        currentLoss++;
                        currentWin = 0;
                        if(currentLoss > maxLoss) maxLoss = currentLoss;
                    }
                    lastBetDate = targetDraw.date;
                    
                    globalTradeHistory.push({
                        date: targetDraw.date,
                        numbers: targetDraw.numbers,
                        signal: `${top1}, ${top2}`,
                        cost: cost,
                        net: dailyPrize - cost,
                        isWin: isWin,
                        targets: [top1, top2] 
                    });
                }
            }
            
            globalTradeHistory.reverse();

            document.getElementById('last-bet-date').innerText = lastBetDate;
            document.getElementById('strategy-desc').innerText = "Sniper-6 (Original): è¿‘15æœŸæ¦œé¦–å‰›å¥½6æ¬¡æ™‚ï¼Œè²·å‰2ç†±è™Ÿã€‚";
            
            return { cost: totalCost, net: totalPrize - totalCost, winDays, tradingDays, totalBetUnits, maxWin, maxLoss, maxDrawdown };
        }

        function changePage(delta) {
            const totalPages = Math.ceil(globalTradeHistory.length / ITEMS_PER_PAGE);
            let newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderFullHistoryTable();
            }
        }

        function renderFullHistoryTable() {
            const tbody = document.getElementById('fullHistoryBody');
            const pageInfo = document.getElementById('pageInfo');
            const totalItems = globalTradeHistory.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
            
            tbody.innerHTML = '';
            pageInfo.innerText = `ç¬¬ ${currentPage} / ${totalPages} é  (å…± ${totalItems} ç­†)`;

            let start = (currentPage - 1) * ITEMS_PER_PAGE;
            let end = Math.min(start + ITEMS_PER_PAGE, totalItems);

            for (let i = start; i < end; i++) {
                let row = globalTradeHistory[i];
                let tr = document.createElement('tr');
                
                let numsHtml = row.numbers.map(n => {
                    let className = "num-ball";
                    if (currentMode === 'A') {
                        let is0 = HEADS[0].includes(n);
                        let isP1 = HEADS[row.heads.p1].includes(n);
                        let isP2 = HEADS[row.heads.p2].includes(n);
                        if (is0) className += " num-hit-0";
                        else if (isP1) className += " num-hit-1";
                        else if (isP2 && (row.signal.includes('&'))) className += " num-hit-2";
                    } else {
                        if (row.targets && row.targets.includes(n)) className += " num-hit-1"; 
                    }
                    return `<span class="${className}">${n<10?'0'+n:n}</span>`;
                }).join('');

                let resBadge = row.isWin ? `<span class="res-badge badge-win">WIN</span>` : `<span class="res-badge badge-loss">LOSS</span>`;
                let netColor = row.net > 0 ? "var(--win)" : "var(--loss)";

                tr.innerHTML = `
                    <td style="color:#bdc3c7">${row.date.slice(5)}</td>
                    <td>${numsHtml}</td>
                    <td style="color:var(--gold)">${row.signal}</td>
                    <td>$${row.cost.toLocaleString()}</td>
                    <td style="color:${netColor}; font-weight:bold;">${row.net > 0 ? '+' : ''}$${row.net.toLocaleString()}</td>
                    <td>${resBadge}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function updateEquityChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            let chronoHistory = [...globalTradeHistory].reverse();
            let labels = chronoHistory.map(d => d.date); 
            let data = [];
            let accum = 0;
            
            chronoHistory.forEach(d => {
                accum += d.net;
                data.push(accum);
            });
            
            if (equityChartInstance) {
                equityChartInstance.destroy();
            }
            
            const yearBackgroundPlugin = {
                id: 'yearBackground',
                beforeDraw: (chart) => {
                    const { ctx, chartArea: { top, bottom, height }, scales: { x } } = chart;
                    
                    ctx.save();
                    
                    let currentYear = null;
                    let startX = x.getPixelForValue(0);
                    
                    const bgColors = [
                        'rgba(255, 255, 255, 0.02)', 
                        'rgba(255, 255, 255, 0.08)' 
                    ];
                    
                    const labels = chart.data.labels;
                    
                    const drawSegment = (start, end, year) => {
                        const width = end - start;
                        const colorIndex = parseInt(year) % 2;
                        
                        ctx.fillStyle = bgColors[colorIndex];
                        ctx.fillRect(start, top, width, height);
                        
                        ctx.font = 'bold 60px Arial';
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.08)';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        if (width > 50) { 
                            ctx.fillText(year, start + width / 2, top + height / 2);
                        }
                    };

                    for (let i = 0; i < labels.length; i++) {
                        const year = labels[i].split('/')[0];
                        if (year !== currentYear) {
                            if (currentYear !== null) {
                                const endX = x.getPixelForValue(i); 
                                drawSegment(startX, endX, currentYear);
                                startX = endX;
                            }
                            currentYear = year;
                        }
                    }
                    const finalX = x.getPixelForValue(labels.length - 1);
                    drawSegment(startX, finalX, currentYear);
                    ctx.restore();
                }
            };

            let gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(0, 184, 148, 0.5)'); 
            gradient.addColorStop(1, 'rgba(0, 184, 148, 0)');

            let finalPnl = data.length > 0 ? data[data.length-1] : 0;
            let lineColor = finalPnl >= 0 ? '#00b894' : '#ff7675';

            equityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, 
                    datasets: [{
                        label: 'ç´¯ç©æç›Š (Equity)',
                        data: data,
                        borderColor: lineColor,
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0, 
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (context) => context[0].label,
                                label: function(context) {
                                    return 'ç´¯ç©æç›Š: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }, 
                            ticks: { 
                                color: '#95a5a6', 
                                maxTicksLimit: 12,
                                callback: function(val, index) {
                                    const label = this.getLabelForValue(val);
                                    return label.slice(5); 
                                }
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#bdc3c7' }
                        }
                    }
                },
                plugins: [yearBackgroundPlugin] 
            });
        }

        // ==========================================
        //  FIXED: MISSING FUNCTION RESTORED
        // ==========================================
        function predictNextDraw() {
            let nextDate = getNextDrawDate(fullData[0].date);
            document.getElementById('nextDrawDate').innerText = nextDate.dateStr;
            document.getElementById('nextWeekday').innerText = nextDate.weekdayStr;
            
            if (currentMode === 'A') {
                let past20 = fullData.slice(0, 20);
                let counts = getHeadCounts(past20);
                let others = {1: counts[1], 2: counts[2], 3: counts[3]};
                let sorted = Object.keys(others).sort((a,b) => others[b] - others[a]);
                let p1 = parseInt(sorted[0]);
                let p2 = parseInt(sorted[1]);
                let gap = others[p1] - others[p2];
                let count0 = counts[0];
                let dayIdx = nextDate.dayIdx; 
                
                let signalType = "stop";
                let comboText = "æš«åœä¸‹æ³¨";
                let descText = "æ¿¾ç¶²æœªé";

                let passFilter = false;
                let reason = "";

                if (currentStrategyA === 'sniper_new' || currentStrategyA === 'peak_martingale') {
                    if (dayIdx === 2) reason = "é€±äºŒé¿æˆ°";
                    else if (count0 > 25) reason = "0é ­éç†±(>25)";
                    else passFilter = true;
                } else if (currentStrategyA === 'shield_new') {
                    if (dayIdx === 2 || dayIdx === 3) reason = "é€±äºŒä¸‰é¿æˆ°";
                    else if (count0 > 22) reason = "0é ­éç†±(>22)";
                    else passFilter = true;
                }

                if (passFilter) {
                    if (currentStrategyA === 'peak_martingale') {
                        signalType = "strong"; 
                        comboText = `0+${p1}`;
                        descText = "æ¥µé™å‡¹å–®: ä¾è³‡é‡‘æ°´ä½æ±ºå®šå€æ•¸";
                    } else {
                        if (gap >= 6) { signalType="super"; comboText=`0+${p1} (x2)`; descText="å¼·åŠ›è¨Šè™Ÿ"; }
                        else if (gap <= 2) { signalType="strong"; comboText=`0+${p1} & 0+${p2}`; descText="é›™é¾é˜²ç¦¦"; }
                        else { signalType="weak"; comboText=`0+${p1}`; descText="æ¨™æº–è¨Šè™Ÿ"; }
                    }
                } else {
                    descText = reason;
                }
                
                document.getElementById('pred-combo').innerText = comboText;
                document.getElementById('pred-desc').innerText = descText;
                
                ['btn-super','btn-strong','btn-weak','btn-stop'].forEach(id => document.getElementById(id).classList.remove('active'));
                document.getElementById(`btn-${signalType}`).classList.add('active');

            } else {
                let past15 = fullData.slice(0, 15);
                let numCounts = {};
                for(let k=1; k<=39; k++) numCounts[k] = 0;
                past15.forEach(d => d.numbers.forEach(n => numCounts[n]++));
                
                let sortedNums = Object.keys(numCounts).sort((a,b) => {
                    let diff = numCounts[b] - numCounts[a];
                    if(diff!==0) return diff;
                    return parseInt(a) - parseInt(b);
                });
                
                let top1 = sortedNums[0];
                let top1_c = numCounts[top1];
                let top2 = sortedNums[1];
                let top2_c = numCounts[top2];
                
                document.getElementById('sniper-status').style.display = 'none';
                document.getElementById('sniper-balls-container').style.display = 'flex';
                
                document.getElementById('ball-1').innerText = top1 < 10 ? '0'+top1 : top1;
                document.getElementById('ball-2').innerText = top2 < 10 ? '0'+top2 : top2;
                
                const box = document.querySelector('#panel-mode-b .strategy-box');
                if (top1_c === 6) {
                    box.style.borderColor = "var(--sniper)";
                    box.style.background = "rgba(142, 68, 173, 0.1)";
                    box.innerHTML = `<div style='text-align:center; color:#fff; font-weight:bold;'>ğŸ¯ è¨Šè™Ÿæˆç«‹ (æ¦œé¦–6æ¬¡)<br><span style='font-size:12px; font-weight:normal;'>å»ºè­°ä¸‹æ³¨é€™å…©ç¢¼</span></div>`;
                } else {
                    box.style.borderColor = "#555";
                    box.style.background = "rgba(0,0,0,0.2)";
                    box.innerHTML = `<div style='text-align:center; color:#7f8c8d;'>ğŸ›‘ è¨Šè™Ÿæœªæˆç«‹ (æ¦œé¦–${top1_c}æ¬¡)<br><span style='font-size:12px;'>éœ€å‰›å¥½6æ¬¡æ‰é€²å ´</span></div>`;
                }
            }
        }

        function getHeadCounts(history) {
            let c = {0:0, 1:0, 2:0, 3:0};
            history.forEach(d => d.numbers.forEach(n => {
                if(n<=9) c[0]++; else if(n<=19) c[1]++; else if(n<=29) c[2]++; else c[3]++;
            }));
            return c;
        }

        function checkPrizeA(nums, hA, hB) {
            let hitsA = 0, hitsB = 0, hitsC = 0;
            let setA = HEADS[hA], setB = HEADS[hB];
            nums.forEach(n => {
                if(setA.includes(n)) hitsA++; else if(setB.includes(n)) hitsB++; else hitsC++;
            });
            let sorted = [hitsA, hitsB, hitsC].sort((a,b)=>a-b);
            if(sorted[0]===1 && sorted[1]===2 && sorted[2]===2) return PRIZE_4;
            if(sorted[0]===1 && sorted[1]===1 && sorted[2]===3) return PRIZE_3;
            return 0;
        }

        function getNextDrawDate(lastDateStr) {
            let last = new Date(lastDateStr);
            let next = new Date(last);
            next.setDate(last.getDate() + 1);
            if(next.getDay() === 0) next.setDate(next.getDate() + 1);
            
            let m = (next.getMonth()+1).toString().padStart(2,'0');
            let d = next.getDate().toString().padStart(2,'0');
            let w = "æ—¥ä¸€äºŒä¸‰å››äº”å…­"[next.getDay()];
            return { dateStr: `${m}/${d}`, weekdayStr: `é€±${w}`, dayIdx: next.getDay() };
        }

        function updateStatBox(res) {
            document.getElementById('st-profit').innerText = `$${res.net.toLocaleString()}`;
            document.getElementById('st-profit').className = res.net > 0 ? "stat-value val-win" : "stat-value val-loss";
            let roi = res.cost > 0 ? (res.net / res.cost * 100).toFixed(1) : 0;
            document.getElementById('st-roi').innerText = `${roi}%`;
            
            let winRate = res.tradingDays > 0 ? (res.winDays / res.tradingDays * 100).toFixed(1) : 0;
            document.getElementById('st-winrate').innerText = `${winRate}%`;
            
            document.getElementById('st-count').innerText = res.totalBetUnits || res.tradingDays; 
            document.getElementById('st-max-win').innerText = res.maxWin;
            document.getElementById('st-max-loss').innerText = res.maxLoss;
            document.getElementById('st-mdd').innerText = res.maxDrawdown ? `$${res.maxDrawdown.toLocaleString()}` : '--';
            document.getElementById('real-test-count-disp').innerText = fullData.length;
            document.getElementById('st-unit').innerText = document.getElementById('baseUnit').value;
        }
    </script>
</div>
</body>
</html>
