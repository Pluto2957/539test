<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 æ™ºèƒ½æ“ç›¤ç³»çµ± (v3.1 Sequence)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a; --glass-bg: rgba(30, 41, 59, 0.7); --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #6366f1; --secondary: #ec4899; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --text-main: #f8fafc; --text-muted: #94a3b8; --card-radius: 16px;
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: var(--bg-dark);
            background-image: radial-gradient(at 0% 0%, rgba(99,102,241,0.15), transparent 50%), radial-gradient(at 100% 0%, rgba(236,72,153,0.15), transparent 50%);
            color: var(--text-main); margin: 0; padding: 20px; box-sizing: border-box;
        }
        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 24px; }
        
        /* Components */
        header { padding: 24px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--card-radius); backdrop-filter: blur(12px); text-align: center; position: relative; overflow: hidden; }
        header::after { content:''; position: absolute; bottom:0; left:0; width:100%; height:2px; background: linear-gradient(90deg, var(--primary), var(--secondary)); }
        h1 { margin: 0; background: linear-gradient(135deg, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 28px; }

        .mode-switcher { display: flex; gap: 12px; padding: 6px; background: rgba(15,23,42,0.6); border-radius: 12px; border: 1px solid var(--glass-border); }
        .mode-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 8px; font-weight: 600; transition: 0.3s; }
        .mode-btn.active { color: white; background: rgba(255,255,255,0.1); }
        body.mode-a #btnModeA.active { border-bottom: 2px solid var(--primary); }
        body.mode-b #btnModeB.active { border-bottom: 2px solid var(--secondary); }

        .status-container { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; position: relative; overflow: hidden; }
        .status-bar-content { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; }
        .status-progress-bar { height: 3px; width: 100%; background: rgba(255,255,255,0.05); position: absolute; bottom: 0; }
        .status-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.3s; }
        .indeterminate { width: 30%; animation: loading-bar 1.5s infinite linear; }
        @keyframes loading-bar { 0% { left: -30%; } 100% { left: 100%; } }

        .dashboard { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media(min-width: 992px) { .dashboard { grid-template-columns: 1fr 1fr; } }
        
        .card { background: var(--glass-bg); padding: 24px; border-radius: var(--card-radius); border: 1px solid var(--glass-border); backdrop-filter: blur(16px); position: relative; }
        .card h2 { margin: 0 0 20px; font-size: 18px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; display: flex; justify-content: space-between; }
        .card-tag { font-size: 11px; padding: 4px 10px; border-radius: 20px; background: linear-gradient(90deg, var(--primary), #818cf8); }

        /* Controls */
        .strategy-control-panel { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; display: flex; flex-direction: column; gap: 16px; margin-bottom: 20px; }
        .control-row { display: flex; gap: 12px; }
        .strategy-select, .unit-input { background: #1e293b; border: 1px solid #475569; color: white; border-radius: 8px; padding: 10px; }
        .strategy-select { width: 100%; padding: 12px; outline: none; }
        .unit-input-group { display: flex; align-items: center; gap: 10px; background: #1e293b; padding: 4px 12px; border-radius: 8px; border: 1px solid #475569; }
        .unit-input { width: 50px; border: none; text-align: center; font-weight: 700; color: var(--warning); background: transparent; outline: none; }
        .btn-switch, .btn-fetch, .btn-reset { border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: white; transition: transform 0.2s; }
        .btn-switch { background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 0 20px; white-space: nowrap; }
        .btn-reset { background: linear-gradient(135deg, #ef4444, #b91c1c); padding: 8px 16px; font-size: 13px; }
        .btn-fetch { background: linear-gradient(135deg, var(--primary), #4f46e5); padding: 14px; width: 100%; margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .btn-switch:hover, .btn-fetch:hover, .btn-reset:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* Stats Grid */
        .strategy-box { background: rgba(15,23,42,0.4); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; }
        .strategy-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 16px; font-weight: 700; color: white; }
        .val-win { color: var(--success); } .val-loss { color: var(--danger); }
        
        /* Prediction & History */
        .signal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .signal-btn { padding: 15px; border-radius: 12px; text-align: center; background: rgba(30,41,59,0.5); color: #64748b; border: 1px solid transparent; transition: 0.3s; }
        .signal-btn.active { color: white; transform: scale(1.02); border-color: rgba(255,255,255,0.5); }
        .sig-super.active { background: linear-gradient(135deg, #f97316, #ef4444); }
        .sig-strong.active { background: linear-gradient(135deg, #10b981, #06b6d4); }
        .sig-weak.active { background: linear-gradient(135deg, #64748b, #475569); }
        .sig-stop.active { background: linear-gradient(135deg, #475569, #1e293b); color: #ef4444; }

        .sniper-balls { display: flex; justify-content: center; gap: 24px; margin: 24px 0; }
        .s-ball { width: 64px; height: 64px; line-height: 64px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #d8b4fe, #7c3aed); color: white; text-align: center; font-size: 26px; font-weight: 800; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 0 20px rgba(124,58,237,0.6); }

        .full-history-card { grid-column: 1 / -1; }
        .history-table-container { overflow-x: auto; border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; }
        .full-history-table { width: 100%; border-collapse: collapse; white-space: nowrap; font-size: 14px; text-align: center; }
        .full-history-table th { background: rgba(30,41,59,0.9); padding: 14px; color: var(--text-muted); }
        .full-history-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #e2e8f0; }
        
        .num-ball { display: inline-block; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; font-size: 12px; margin: 0 2px; color: #94a3b8; background: #1e293b; font-weight: bold; }
        .num-hit-0 { background: #ef4444; color: white; } .num-hit-1 { background: #f59e0b; color: black; } .num-hit-2 { background: #06b6d4; color: white; }
        .res-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 800; }
        .badge-win { background: rgba(16,185,129,0.15); color: #34d399; } .badge-loss { background: rgba(239,68,68,0.15); color: #f87171; }

        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 10px; }
        #manualInputSection { display: none; margin-top: 10px; padding: 15px; background: #991b1b; border-radius: 8px; text-align: center; }
        .progress-overlay { position: absolute; inset:0; background: rgba(15,23,42,0.9); z-index: 10; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spin { animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.7); z-index: 999; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { opacity: 1; }
        .modal-box { background: #1e293b; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; transform: scale(0.9); transition: transform 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; }
    </style>
</head>
<body class="mode-a">

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <div id="modalIcon" style="font-size:40px; margin-bottom:10px;"></div>
        <div id="modalTitle" style="font-size:20px; font-weight:bold; color:white; margin-bottom:10px;"></div>
        <div id="modalMsg" style="color:#cbd5e1; line-height:1.6;"></div>
        <div id="modalActions" class="modal-actions"></div>
    </div>
</div>

<div class="container">
    <header>
        <h1>Lotto 539 Trading System</h1>
    </header>

    <div class="mode-switcher">
        <button class="mode-btn active" id="btnModeA" onclick="App.setMode('A')">ç©æ³• Aï¼šè°æ˜åŒ…ç‰Œ</button>
        <button class="mode-btn" id="btnModeB" onclick="App.setMode('B')">ç©æ³• Bï¼šç¨æ”¯ Sniper</button>
    </div>

    <div class="status-container">
        <div class="status-bar-content">
            <div class="status-text-group">
                <div id="statusText" style="font-weight:600;">â³ ç³»çµ±å•Ÿå‹•ä¸­...</div>
                <div class="data-info-block" id="dataInfoBlock" style="font-size:12px; color:var(--text-muted);"></div>
            </div>
            <button class="btn-reset" onclick="App.resetData()" id="btnResetData">ğŸ”„ é‡æ–°é©—è­‰æ•¸æ“š</button>
        </div>
        <div class="status-progress-bar"><div class="status-progress-fill" id="statusProgressBar"></div></div>
    </div>

    <div id="manualInputSection">
        <p style="color:white; font-weight:bold;">âš ï¸ è‡ªå‹•æ›´æ–°å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æœ€æ–°ä¸€æœŸï¼š</p>
        <div style="display:flex; justify-content:center; gap:5px; margin-bottom:10px;">
            <input type="number" id="m1" style="width:40px;"><input type="number" id="m2" style="width:40px;">
            <input type="number" id="m3" style="width:40px;"><input type="number" id="m4" style="width:40px;">
            <input type="number" id="m5" style="width:40px;">
        </div>
        <button onclick="App.manualInput()" style="padding:5px 15px; cursor:pointer;">ç¢ºèª</button>
    </div>

    <div class="dashboard">
        <div class="card">
            <h2><span>ğŸ’° ç­–ç•¥å›æ¸¬å ±å‘Š</span><span class="card-tag" id="current-strategy-tag">New Sniper</span></h2>
            <div class="strategy-control-panel">
                <div class="control-row">
                    <select id="strategySelect" class="strategy-select"></select>
                </div>
                <div class="control-row">
                    <div class="unit-input-group">
                        <span style="font-size:13px; color:#cbd5e1;">åŸºæœ¬å–®ä½ ($):</span>
                        <input type="number" id="baseUnit" class="unit-input" value="1" min="1">
                    </div>
                    <button class="btn-switch" onclick="App.runAnalysis()">åˆ‡æ› / è¨ˆç®—</button>
                </div>
            </div>
            <div class="progress-overlay" id="loadingBar">
                <div style="color:white; font-weight:bold;">AI é‹ç®—ä¸­...</div>
                <div style="width:60%; height:6px; background:#334155; border-radius:10px; margin-top:10px; overflow:hidden;"><div style="height:100%; background:var(--primary); width:0%; transition:width 0.3s;" id="progressFill"></div></div>
            </div>
            <div class="strategy-box">
                <div class="strategy-grid">
                    <div class="stat-item"><div class="stat-label">ç´¯ç©æ·¨åˆ©</div><div class="stat-value" id="st-profit">--</div></div>
                    <div class="stat-item"><div class="stat-label">ROI</div><div class="stat-value" id="st-roi">--%</div></div>
                    <div class="stat-item"><div class="stat-label">å‹ç‡</div><div class="stat-value" id="st-winrate">--%</div></div>
                    <div class="stat-item"><div class="stat-label">ç¸½å–®æ•¸</div><div class="stat-value" id="st-count">--</div></div>
                    <div class="stat-item"><div class="stat-label">æœ€å¤§é€£å‹</div><div class="stat-value val-win" id="st-max-win">--</div></div>
                    <div class="stat-item"><div class="stat-label">æœ€å¤§é€£æ•—</div><div class="stat-value val-loss" id="st-max-loss">--</div></div>
                    <div class="stat-item"><div class="stat-label">MDD</div><div class="stat-value val-loss" id="st-mdd">--</div></div>
                </div>
                <div id="strategy-desc" style="font-size:12px; color:var(--text-muted); margin-top:10px; text-align:center;"></div>
            </div>
        </div>

        <div class="card">
            <h2><span>ğŸ”® ä¸‹ä¸€æœŸæ“ç›¤å»ºè­°</span><span class="card-tag" style="background:#ec4899;">Signal</span></h2>
            <div style="text-align:center; padding:10px 0;">
                <div style="font-size:13px; color:var(--text-muted);">æœ€å¾Œè¨Šè™Ÿæ—¥: <span id="last-bet-date" style="color:var(--primary);">--/--</span></div>
                <div id="nextDrawDate" style="font-size:24px; font-weight:800; color:white; margin-top:5px;">--/--</div>
                <div id="nextWeekday" style="font-size:16px; color:var(--secondary); font-weight:bold;">é€±--</div>
            </div>

            <div id="panel-mode-a">
                <div class="signal-grid">
                    <div id="btn-super" class="signal-btn sig-super">ğŸ”¥ å¼·åŠ›è¨Šè™Ÿ<br><small>2å€+</small></div>
                    <div id="btn-strong" class="signal-btn sig-strong">âš¡ å‡¹å–®è¨Šè™Ÿ<br><small>åºåˆ—åŠ ç¢¼</small></div>
                    <div id="btn-weak" class="signal-btn sig-weak">â„ï¸ æ¨™æº–è¨Šè™Ÿ<br><small>1å€ P1</small></div>
                    <div id="btn-stop" class="signal-btn sig-stop">ğŸ›‘ æš«åœ/é¢¨éšª<br><small>æ¿¾ç¶²æœªé</small></div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:22px; font-weight:bold; color:var(--warning);" id="pred-combo">--</div>
                    <div style="font-size:13px; color:var(--text-muted);" id="pred-desc">--</div>
                </div>
            </div>

            <div id="panel-mode-b" style="display:none;">
                <div id="sniper-status" style="text-align:center; margin-bottom:15px; color:var(--text-muted);">æª¢æ¸¬ä¸­...</div>
                <div class="sniper-balls" id="sniper-balls-container" style="display:none;">
                    <div><div class="s-ball" id="ball-1">--</div><div style="text-align:center; font-size:12px; margin-top:5px; color:#aaa;">Top 1</div></div>
                    <div><div class="s-ball" id="ball-2">--</div><div style="text-align:center; font-size:12px; margin-top:5px; color:#aaa;">Top 2</div></div>
                </div>
                <div class="strategy-box" id="sniper-msg-box" style="text-align:center; font-size:14px;"></div>
            </div>
            
            <button id="btnFetch" class="btn-fetch" onclick="Data.forceFetch()">
                <span id="fetchIcon">ğŸ”„</span><span id="fetchText">æ‰‹å‹•æŠ“å–æœ€æ–°æ•¸æ“š</span>
            </button>
        </div>
        
        <div class="card full-history-card">
            <h2><span>ğŸ“œ è©³ç´°æ­·å²ç´€éŒ„</span></h2>
            <div class="history-table-container">
                <table class="full-history-table">
                    <thead><tr><th>æ—¥æœŸ</th><th>é–‹çè™Ÿç¢¼</th><th>è¨Šè™Ÿ</th><th>ä¸‹æ³¨</th><th>æ·¨æç›Š</th><th>çµæœ</th></tr></thead>
                    <tbody id="fullHistoryBody"></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content:center; gap:15px; margin-top:20px;">
                <button onclick="UI.changePage(-1)" style="padding:8px; cursor:pointer;">â—€</button>
                <span id="pageInfo" style="line-height:30px;">1 / 1</span>
                <button onclick="UI.changePage(1)" style="padding:8px; cursor:pointer;">â–¶</button>
            </div>
        </div>
        
        <div class="card full-history-card">
            <h2><span>ğŸ“ˆ è³‡é‡‘æ¬Šç›Šèµ°å‹¢åœ–</span></h2>
            <div class="chart-container"><canvas id="equityChart"></canvas></div>
        </div>
    </div>
    
    <script>
        // --- 1. Helper & Config ---
        const $ = id => document.getElementById(id);
        const CONST = {
            DRIVE_ID: '1K2CNRIE97NRfJrzKiG8Adcz_tFeYHPlm',
            STORAGE: 'lotto539_data_slim_v1',
            BASE_URL: "https://www.lotto-8.com/listlto539.asp",
            COST_A: 1062, PRIZE_3: 1710, PRIZE_4: 2280,
            COST_B: 5700, PRIZE_B: 21200,
            HEADS: { 0:[1,2,3,4,5,6,7,8,9], 1:[11,12,13,14,15,16,17,18,19], 2:[21,22,23,24,25,26,27,28,29], 3:[31,32,33,34,35,36,37,38,39] }
        };

        let AppState = { fullData: [], mode: 'A', history: [], page: 1, chart: null };

        // --- 2. Data Module ---
        const Data = {
            async init() {
                try { AppState.fullData = JSON.parse(localStorage.getItem(CONST.STORAGE) || '[]'); } catch(e){}
                if(AppState.fullData.length === 0) await this.fetchCloud();
                this.forceFetch(true);
            },
            async fetchCloud() {
                UI.status("â˜ï¸ åŒæ­¥é›²ç«¯æ•¸æ“š...", "syncing");
                try {
                    const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://drive.google.com/uc?export=download&id=${CONST.DRIVE_ID}`)}`);
                    const data = await res.json();
                    this.merge(data);
                } catch(e) { console.error(e); }
            },
            async forceFetch(isAuto = false) {
                if(!isAuto) {
                    $('btnFetch').disabled = true; $('fetchText').innerText = "æ›´æ–°ä¸­..."; $('fetchIcon').classList.add('spin');
                }
                UI.status("ğŸ“¡ æŠ“å–æœ€æ–°é–‹ç...", "syncing");
                let newData = [];
                const proxies = [
                    u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}&timestamp=${Date.now()}`,
                    u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`
                ];
                try {
                    for(let i=1; i<=3; i++) {
                        let url = i===1 ? CONST.BASE_URL : `${CONST.BASE_URL}?indexpage=${i}&orderby=new`;
                        let html = null;
                        for(let proxy of proxies) {
                            try {
                                let res = await fetch(proxy(url));
                                let txt = res.url.includes("allorigins") ? (await res.json()).contents : await res.text();
                                if(txt.length > 500) { html = txt; break; }
                            } catch(e){}
                        }
                        if(html) {
                            let parsed = this.parseHtml(html);
                            let latest = AppState.fullData[0]?.date || "2000/01/01";
                            let fresh = parsed.filter(row => row.date > latest);
                            if(fresh.length === 0) break; 
                            newData.push(...fresh);
                        }
                    }
                    if(newData.length > 0) {
                        this.merge(newData);
                        UI.status(`âœ… æ›´æ–° ${newData.length} ç­†è³‡æ–™`, "success");
                        App.runAnalysis();
                    } else {
                        UI.status("âœ… è³‡æ–™å·²æ˜¯æœ€æ–°", "success");
                    }
                } catch(e) { 
                    if(!isAuto) $('manualInputSection').style.display = 'block';
                    UI.status("âš ï¸ é€£ç·šç•°å¸¸ï¼Œè«‹æ‰‹å‹•è¼¸å…¥", "loading");
                }
                if(!isAuto) {
                    $('btnFetch').disabled = false; $('fetchText').innerText = "æ‰‹å‹•å¼·åˆ¶æ›´æ–°"; $('fetchIcon').classList.remove('spin');
                }
            },
            merge(newData) {
                const map = new Map();
                [...newData, ...AppState.fullData].forEach(d => map.set(d.date, d));
                AppState.fullData = Array.from(map.values()).sort((a,b) => b.date.localeCompare(a.date));
                localStorage.setItem(CONST.STORAGE, JSON.stringify(AppState.fullData));
                UI.updateInfo();
            },
            parseHtml(html) {
                const doc = new DOMParser().parseFromString(html, "text/html");
                let res = [];
                doc.querySelectorAll("tr").forEach(row => {
                    const txt = row.innerText.trim();
                    const dMatch = txt.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
                    if(dMatch) {
                        let allNums = txt.match(/\d{2}/g) || [];
                        let valid = [];
                        for(let i=allNums.length-1; i>=0; i--) {
                            let n = parseInt(allNums[i]);
                            if(n>=1 && n<=39 && !valid.includes(n)) valid.unshift(n);
                            if(valid.length===5) break;
                        }
                        if(valid.length===5) res.push({ 
                            date: `${dMatch[1]}/${dMatch[2].padStart(2,'0')}/${dMatch[3].padStart(2,'0')}`, 
                            numbers: valid 
                        });
                    }
                });
                return res;
            }
        };

        // --- 3. Strategy Logic (With Sequence Martingale) ---
        const Strategy = {
            getHeads(nums) {
                return nums.reduce((acc, n) => {
                    if(n<=9) acc[0]++; else if(n<=19) acc[1]++; else if(n<=29) acc[2]++; else acc[3]++;
                    return acc;
                }, {0:0, 1:0, 2:0, 3:0});
            },
            checkPrizeA(nums, hA, hB) {
                let hits = {A:0, B:0, C:0};
                nums.forEach(n => {
                    if(CONST.HEADS[hA].includes(n)) hits.A++;
                    else if(CONST.HEADS[hB].includes(n)) hits.B++;
                    else hits.C++;
                });
                let s = Object.values(hits).sort((a,b)=>a-b);
                if(s[0]===1 && s[1]===2 && s[2]===2) return CONST.PRIZE_4;
                if(s[0]===1 && s[1]===1 && s[2]===3) return CONST.PRIZE_3;
                return 0;
            },
            runA(strategy, unit) {
                let stats = { cost:0, net:0, wins:0, trades:0, count:0, maxW:0, maxL:0, mdd:0 };
                let equity=0, peak=0, curW=0, curL=0;
                let data = AppState.fullData, hist = [];
                
                // Variables for Martingale Logic
                let martMult = 1; // Standard Peak Martingale
                const SEQ = [1, 2, 3, 6, 9]; // Sequence Martingale
                let seqIdx = 0;
                let lastWin = false;
                let lastDate = "ç„¡";

                for(let i=data.length-21; i>=0; i--) {
                    let today = data[i], past20 = data.slice(i+1, i+21);
                    if(past20.length<20) continue;
                    
                    let counts = past20.reduce((acc, d) => {
                         d.numbers.forEach(n => acc[n<=9?0:(n<=19?1:(n<=29?2:3))]++); return acc; 
                    }, {0:0,1:0,2:0,3:0});

                    let sorted = [1,2,3].sort((a,b) => counts[b]-counts[a]);
                    let p1=sorted[0], p2=sorted[1], gap=counts[p1]-counts[p2], c0=counts[0];
                    let day = new Date(today.date).getDay();
                    
                    let isTrade = false;
                    // Filter Logic
                    if(strategy.includes('sniper') || strategy.includes('peak') || strategy === 'seq_martingale') {
                        isTrade = (day!==2 && c0<=25);
                    } else if(strategy.includes('shield')) {
                        isTrade = (day!==2 && day!==3 && c0<=22);
                    }

                    if(isTrade) {
                        let bet = 1, prize = 0, txt = "";
                        
                        // Strategy Branching
                        if(strategy === 'seq_martingale') {
                            // --- Modified Peak Martingale (Sequence: 1-2-3-6-9) ---
                            // Logic: If Equity < Peak, follow sequence on loss. Reset on Win or New High.
                            if(equity >= peak) {
                                bet = 1; seqIdx = 0;
                            } else {
                                // Drawdown mode
                                if(lastWin) {
                                    bet = 1; seqIdx = 0; // Win resets sequence
                                } else {
                                    bet = SEQ[seqIdx]; // Loss moves up sequence
                                }
                            }
                            
                            prize = this.checkPrizeA(today.numbers, 0, p1) * bet * unit;
                            txt = `0+${p1} (${bet}x)`;
                            if(bet > 1) txt = `0+${p1} (å‡¹x${bet})`;

                        } else if(strategy.includes('peak')) {
                            // --- Original Peak Martingale (Doubling) ---
                            if(equity >= peak) martMult = 1;
                            else if(!lastWin) martMult = Math.min(martMult*2, 16);
                            bet = martMult;
                            prize = this.checkPrizeA(today.numbers, 0, p1) * bet * unit;
                            txt = `0+${p1} (${bet}x)`;
                        } else {
                            // --- Standard Sniper / Shield ---
                            if(gap >= 6) { bet=2; prize = this.checkPrizeA(today.numbers, 0, p1)*2*unit; txt=`0+${p1} (x2)`; }
                            else if(gap <= 2) { bet=2; prize = (this.checkPrizeA(today.numbers,0,p1) + this.checkPrizeA(today.numbers,0,p2))*unit; txt=`0+${p1}&${p2}`; }
                            else { prize = this.checkPrizeA(today.numbers, 0, p1)*unit; txt=`0+${p1}`; }
                        }
                        
                        let cost = bet * CONST.COST_A * unit;
                        let net = prize - cost;
                        let isWin = net > 0;
                        
                        stats.cost += cost; stats.net += net; stats.trades++; stats.count += bet;
                        equity += net;
                        if(equity > peak) peak = equity;
                        if(equity - peak < stats.mdd) stats.mdd = equity - peak;
                        
                        if(isWin) { stats.wins++; curW++; curL=0; if(curW>stats.maxW) stats.maxW=curW; }
                        else { stats.maxL = Math.max(stats.maxL, ++curL); curW=0; }
                        
                        // Post-Trade Update for Sequence Logic
                        if(strategy === 'seq_martingale') {
                            if(isWin) {
                                seqIdx = 0; // Reset on win
                            } else if(equity < peak) {
                                // Only advance sequence if we are still in drawdown (or just created one)
                                // And limit index to 4 (value 9)
                                if(seqIdx < 4) seqIdx++;
                            }
                        }
                        
                        lastWin = isWin;
                        lastDate = today.date;
                        hist.push({ date: today.date, numbers: today.numbers, signal: txt, cost, net, isWin, heads: {p1, p2} });
                    }
                }
                return { stats, hist: hist.reverse(), lastDate };
            },
            runB(unit) {
                let stats = { cost:0, net:0, wins:0, trades:0, count:0, maxW:0, maxL:0, mdd:0 };
                let equity=0, peak=0, curW=0, curL=0;
                let data = AppState.fullData, hist = [];
                for(let i=data.length-16; i>=0; i--) {
                    let today = data[i], past15 = data.slice(i+1, i+16);
                    if(past15.length<15) continue;
                    let freq = {};
                    past15.forEach(d => d.numbers.forEach(n => freq[n] = (freq[n]||0)+1));
                    let top = Object.keys(freq).sort((a,b) => freq[b]-freq[a] || a-b);
                    let t1 = parseInt(top[0]), t2 = parseInt(top[1]);
                    if(freq[t1] === 6) {
                        let cost = CONST.COST_B * unit, prize = 0;
                        if(today.numbers.includes(t1)) prize += CONST.PRIZE_B * unit;
                        if(today.numbers.includes(t2)) prize += CONST.PRIZE_B * unit;
                        let net = prize - cost;
                        stats.cost += cost; stats.net += net; stats.trades++; stats.count+=2;
                        equity += net; if(equity > peak) peak=equity;
                        if(equity - peak < stats.mdd) stats.mdd = equity - peak;
                        if(net > 0) { stats.wins++; curW++; curL=0; if(curW>stats.maxW) stats.maxW=curW; }
                        else { curL++; curW=0; if(curL>stats.maxL) stats.maxL=curL; }
                        hist.push({ date: today.date, numbers: today.numbers, signal: `${t1}, ${t2}`, cost, net, isWin: net>0, targets:[t1,t2] });
                    }
                }
                return { stats, hist: hist.reverse(), lastDate: hist.length ? hist[0].date : "ç„¡" };
            }
        };

        // --- 4. UI Module ---
        const UI = {
            status(msg, type) {
                $('statusText').innerText = msg;
                let bar = $('statusProgressBar');
                if(type === 'loading' || type === 'syncing') { bar.className='status-progress-fill indeterminate'; bar.style.width='30%'; }
                else { bar.className='status-progress-fill'; bar.style.width='100%'; setTimeout(()=>bar.style.width='0%',1000); }
            },
            updateInfo() {
                if(AppState.fullData.length) {
                    $('dataInfoBlock').innerHTML = `${AppState.fullData[AppState.fullData.length-1].date} ~ ${AppState.fullData[0].date}<br><span style="color:var(--primary); font-weight:bold">åº«å­˜: ${AppState.fullData.length} æœŸ</span>`;
                }
            },
            showModal(title, msg, onConfirm) {
                const m = $('customModal');
                $('modalIcon').innerText = onConfirm ? 'âš ï¸' : 'âœ…';
                $('modalTitle').innerText = title;
                $('modalMsg').innerHTML = msg;
                const act = $('modalActions'); act.innerHTML = '';
                if(onConfirm) {
                    let b1 = document.createElement('button'); b1.className='modal-btn'; b1.style.background='#334155'; b1.innerText='å–æ¶ˆ'; b1.onclick = () => m.classList.remove('show') || setTimeout(()=>m.style.display='none',300);
                    let b2 = document.createElement('button'); b2.className='modal-btn'; b2.style.background='#ef4444'; b2.innerText='ç¢ºå®š'; b2.onclick = () => { m.classList.remove('show'); setTimeout(()=>m.style.display='none',300); onConfirm(); };
                    act.append(b1, b2);
                } else {
                    let b = document.createElement('button'); b.className='modal-btn'; b.style.background='#6366f1'; b.innerText='å¥½'; b.onclick = () => m.classList.remove('show') || setTimeout(()=>m.style.display='none',300);
                    act.append(b);
                }
                m.style.display='flex'; setTimeout(()=>m.classList.add('show'), 10);
            },
            renderStats(res, unit) {
                $('st-profit').innerText = `$${res.stats.net.toLocaleString()}`;
                $('st-profit').className = res.stats.net > 0 ? "stat-value val-win" : "stat-value val-loss";
                $('st-roi').innerText = res.stats.cost ? (res.stats.net/res.stats.cost*100).toFixed(1)+'%' : '0%';
                $('st-winrate').innerText = res.stats.trades ? (res.stats.wins/res.stats.trades*100).toFixed(1)+'%' : '0%';
                $('st-count').innerText = res.stats.count || 0;
                $('st-max-win').innerText = res.stats.maxW;
                $('st-max-loss').innerText = res.stats.maxL;
                $('st-mdd').innerText = res.stats.mdd.toLocaleString();
                $('last-bet-date').innerText = res.lastDate;
            },
            renderHistory() {
                const t = $('fullHistoryBody'); t.innerHTML = '';
                const start = (AppState.page-1)*10, end = Math.min(start+10, AppState.history.length);
                $('pageInfo').innerText = `ç¬¬ ${AppState.page} / ${Math.ceil(AppState.history.length/10) || 1} é `;
                
                for(let i=start; i<end; i++) {
                    let row = AppState.history[i];
                    let balls = row.numbers.map(n => {
                        let cls = 'num-ball';
                        if(AppState.mode==='A') {
                            if(CONST.HEADS[0].includes(n)) cls+=' num-hit-0';
                            else if(CONST.HEADS[row.heads.p1].includes(n)) cls+=' num-hit-1';
                            else if(row.signal.includes('&') && CONST.HEADS[row.heads.p2].includes(n)) cls+=' num-hit-2';
                        } else if(row.targets.includes(n)) cls+=' num-hit-1';
                        return `<span class="${cls}">${n<10?'0'+n:n}</span>`;
                    }).join('');
                    
                    t.innerHTML += `<tr><td style="color:#bdc3c7">${row.date.slice(5)}</td><td>${balls}</td><td style="color:#f59e0b">${row.signal}</td><td>$${row.cost}</td><td style="font-weight:bold; color:${row.net>0?'#34d399':'#f87171'}">${row.net}</td><td><span class="res-badge ${row.isWin?'badge-win':'badge-loss'}">${row.isWin?'WIN':'LOSS'}</span></td></tr>`;
                }
            },
            renderChart() {
                if(AppState.chart) AppState.chart.destroy();
                let acc = 0, data = AppState.history.slice().reverse().map(d => acc += d.net);
                let labels = AppState.history.slice().reverse().map(d => d.date);
                
                const ctx = $('equityChart').getContext('2d');
                const gradient = ctx.createLinearGradient(0,0,0,300);
                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
                
                AppState.chart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label:'æç›Š', data, borderColor: data[data.length-1]>=0?'#10b981':'#ef4444', backgroundColor: gradient, fill: true, borderWidth:2, pointRadius:0, tension:0.1 }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ x:{grid:{display:false}, ticks:{callback:v=>labels[v].slice(5), maxTicksLimit:10}}, y:{grid:{color:'rgba(255,255,255,0.05)'}} } },
                    plugins: [{
                        id: 'yrBg', beforeDraw: (c) => {
                            const ctx = c.ctx, x = c.scales.x;
                            let curYr = null, startX = x.getPixelForValue(0);
                            c.data.labels.forEach((l, i) => {
                                let y = l.split('/')[0];
                                if(y !== curYr) {
                                    if(curYr) { ctx.fillStyle = parseInt(curYr)%2 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.08)'; ctx.fillRect(startX, c.chartArea.top, x.getPixelForValue(i)-startX, c.chartArea.height); ctx.fillStyle='rgba(255,255,255,0.1)'; ctx.fillText(curYr, startX+10, c.chartArea.top+20); }
                                    curYr = y; startX = x.getPixelForValue(i);
                                }
                            });
                            ctx.fillStyle = parseInt(curYr)%2 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.08)'; ctx.fillRect(startX, c.chartArea.top, x.getPixelForValue(c.data.labels.length-1)-startX, c.chartArea.height);
                        }
                    }]
                });
            },
            changePage(d) {
                let max = Math.ceil(AppState.history.length/10);
                AppState.page = Math.min(Math.max(1, AppState.page+d), max);
                this.renderHistory();
            },
            updatePrediction() {
                if(!AppState.fullData.length) return;
                
                let d = new Date(AppState.fullData[0].date);
                d.setDate(d.getDate()+1); if(d.getDay()===0) d.setDate(d.getDate()+1);
                $('nextDrawDate').innerText = `${d.getMonth()+1}/${d.getDate()}`;
                $('nextWeekday').innerText = `é€±${"æ—¥ä¸€äºŒä¸‰å››äº”å…­"[d.getDay()]}`;

                if(AppState.mode === 'A') {
                    let past20 = AppState.fullData.slice(0,20);
                    let counts = past20.reduce((acc,d)=>{ d.numbers.forEach(n=>acc[n<=9?0:(n<=19?1:(n<=29?2:3))]++); return acc;}, {0:0,1:0,2:0,3:0});
                    let sorted = [1,2,3].sort((a,b)=>counts[b]-counts[a]), p1=sorted[0], p2=sorted[1], gap=counts[p1]-counts[p2];
                    
                    let strat = $('strategySelect').value, day = d.getDay(), c0 = counts[0];
                    let pass = true, reason = "", type="weak", txt=`0+${p1}`, sub="æ¨™æº–è¨Šè™Ÿ";

                    if(strat.includes('sniper') || strat.includes('peak') || strat === 'seq_martingale') { 
                        if(day===2) pass=false; if(c0>25) pass=false; 
                    } else if(strat.includes('shield')) { 
                        if(day===2 || day===3) pass=false; if(c0>22) pass=false; 
                    }

                    if(!pass) { 
                        type="stop"; txt="æš«åœä¸‹æ³¨"; sub="æ¿¾ç¶²æœªé"; 
                    } else if(strat === 'seq_martingale') {
                        type="strong"; sub="è«‹ä¾è³‡é‡‘è¦å‰‡(1-2-3-6-9)ä¸‹æ³¨"; 
                    } else if(strat.includes('peak')) { 
                        type="strong"; sub="æ¥µé™å‡¹å–®æ¨¡å¼"; 
                    } else if(gap>=6) { 
                        type="super"; txt+= " (x2)"; sub="å¼·åŠ›è¨Šè™Ÿ"; 
                    } else if(gap<=2) { 
                        type="strong"; txt+= ` & 0+${p2}`; sub="é›™é¾é˜²ç¦¦"; 
                    }

                    $('pred-combo').innerText = txt; $('pred-desc').innerText = sub;
                    document.querySelectorAll('.signal-btn').forEach(b=>b.classList.remove('active'));
                    $(`btn-${type}`).classList.add('active');
                } else {
                    let past15 = AppState.fullData.slice(0,15), freq={};
                    past15.forEach(d=>d.numbers.forEach(n=>freq[n]=(freq[n]||0)+1));
                    let top = Object.keys(freq).sort((a,b)=>freq[b]-freq[a]||a-b);
                    let t1=top[0], t2=top[1];
                    
                    $('ball-1').innerText = t1<10?'0'+t1:t1; $('ball-2').innerText = t2<10?'0'+t2:t2;
                    $('sniper-balls-container').style.display='flex'; $('sniper-status').style.display='none';
                    let box = $('sniper-msg-box');
                    if(freq[t1]===6) { box.style.background='rgba(142,68,173,0.3)'; box.innerHTML='ğŸ¯ è¨Šè™Ÿæˆç«‹<br>é€²å ´æ“ä½œ'; }
                    else { box.style.background='rgba(0,0,0,0.2)'; box.innerHTML=`ğŸ›‘ è¨Šè™Ÿæœªæˆç«‹ (æ¦œé¦–${freq[t1]}æ¬¡)`; }
                }
            }
        };

        // --- 5. Main App Controller ---
        const App = {
            init() {
                Data.init();
                this.setMode('A');
            },
            setMode(m) {
                AppState.mode = m;
                document.body.className = `mode-${m.toLowerCase()}`;
                $('btnModeA').className = m==='A'?'mode-btn active':'mode-btn';
                $('btnModeB').className = m==='B'?'mode-btn active':'mode-btn';
                $('panel-mode-a').style.display = m==='A'?'block':'none';
                $('panel-mode-b').style.display = m==='B'?'block':'none';
                
                const sel = $('strategySelect'); sel.innerHTML = '';
                if(m==='A') {
                    sel.disabled = false;
                    [
                        ['sniper_new','1. ğŸ¥‡ ç¥å°„æ‰‹'],
                        ['shield_new','2. ğŸ›¡ï¸ å …ç›¾é˜²ç¦¦'],
                        ['peak_martingale','3. ğŸ’€ æ¥µé™å‡¹å–®'],
                        ['seq_martingale','4. ğŸ“‰ åºåˆ—å‡¹å–® (1-2-3-6-9)']
                    ].forEach(o=>sel.add(new Option(o[1], o[0])));
                } else {
                    sel.disabled = true; sel.add(new Option('Sniper-6 (Original)', 'sniper'));
                }
                this.runAnalysis();
            },
            runAnalysis() {
                const fill = $('progressFill'); $('loadingBar').style.display='flex'; fill.style.width='10%';
                setTimeout(() => {
                    fill.style.width='100%';
                    setTimeout(() => {
                        let unit = parseFloat($('baseUnit').value)||1;
                        let res = AppState.mode==='A' ? Strategy.runA($('strategySelect').value, unit) : Strategy.runB(unit);
                        
                        AppState.history = res.hist;
                        AppState.page = 1;
                        UI.renderStats(res, unit);
                        UI.renderHistory();
                        UI.renderChart();
                        UI.updatePrediction();
                        
                        let tag = $('strategySelect').options[$('strategySelect').selectedIndex].text;
                        if(tag.includes('.')) tag = tag.split('.')[1].trim();
                        $('current-strategy-tag').innerText = tag;
                        $('loadingBar').style.display='none'; fill.style.width='0%';
                    }, 300);
                }, 200);
            },
            resetData() {
                UI.showModal('ç¢ºèªé‡ç½®', 'ç¢ºå®šè¦æ¸…é™¤å¿«å–ä¸¦é‡æ–°ä¸‹è¼‰å—ï¼Ÿ', async () => {
                    localStorage.removeItem(CONST.STORAGE);
                    AppState.fullData = [];
                    await Data.init();
                });
            },
            manualInput() {
                let nums = [1,2,3,4,5].map(i => parseInt($(`m${i}`).value));
                if(nums.some(isNaN)) return UI.showModal('éŒ¯èª¤', 'è«‹è¼¸å…¥å®Œæ•´5å€‹è™Ÿç¢¼', null);
                let today = new Date().toISOString().split('T')[0].replace(/-/g,'/');
                AppState.fullData.unshift({date: today, numbers: nums});
                Data.merge([]); 
                $('manualInputSection').style.display='none';
                this.runAnalysis();
            }
        };

        window.onload = () => App.init();
    </script>
</div>
</body>
</html>
