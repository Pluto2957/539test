<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 æ™ºèƒ½æ“ç›¤ç³»çµ±-æ¸¬è©¦ç‰ˆæœ¬ </title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* ç¾ä»£åŒ–é…è‰²ç³»çµ± */
            --bg-gradient: radial-gradient(circle at top left, #232526, #414345);
            --bg-dark: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(12px);
            
            --primary: #6366f1; /* Indigo */
            --primary-glow: rgba(99, 102, 241, 0.5);
            --secondary: #ec4899; /* Pink */
            
            --success: #10b981; /* Emerald */
            --danger: #ef4444; /* Red */
            --warning: #f59e0b; /* Amber */
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --card-radius: 16px;
            --btn-radius: 8px;
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0px, transparent 50%);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 24px;
        }

        /* --- Header --- */
        header {
            text-align: center;
            padding: 24px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            backdrop-filter: var(--glass-blur);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }

        /* --- Mode Switcher (Tabs) --- */
        .mode-switcher {
            display: flex;
            gap: 12px;
            padding: 6px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            justify-content: center;
            border: 1px solid var(--glass-border);
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--btn-radius);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-muted);
            background: transparent;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        
        .mode-btn:hover:not(.active) {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        body.mode-a .mode-btn.active#btnModeA { border-bottom: 2px solid var(--primary); }
        body.mode-b .mode-btn.active#btnModeB { border-bottom: 2px solid var(--secondary); }

        /* --- Status Bar & Tools --- */
        .status-container {
            background: var(--glass-bg);
            border-radius: var(--btn-radius);
            border: 1px solid var(--glass-border);
            overflow: hidden; /* For progress bar */
            position: relative;
        }

        .status-bar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            flex-wrap: nowrap; /* Prevent wrapping */
            gap: 15px;
        }

        .status-text-group {
            display: flex;
            flex-direction: column; /* Stack vertically */
            gap: 4px;
            min-width: 0; /* Allow shrinking */
        }

        /* Status Message (Loading...) */
        #statusText {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .loading { color: var(--gold); }
        .success { color: var(--success); }
        .syncing { color: #38bdf8; }

        /* Data Info (Date & Count) */
        .data-info-block {
            display: flex;
            flex-direction: column;
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        
        .data-range-date { color: #cbd5e1; font-family: monospace; }
        .data-count-highlight { color: var(--primary); font-weight: 700; }

        .btn-reset {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            white-space: nowrap; /* Keep button text single line */
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .btn-reset:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4); }
        .btn-reset:active { transform: translateY(1px); }

        /* --- Dynamic Linear Progress Bar --- */
        .status-progress-bar {
            height: 3px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            position: absolute;
            bottom: 0;
            left: 0;
        }
        .status-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        /* Indeterminate Animation state */
        .status-progress-fill.indeterminate {
            width: 30%;
            animation: loading-bar 1.5s infinite linear;
        }
        
        @keyframes loading-bar {
            0% { left: -30%; }
            100% { left: 100%; }
        }

        /* --- Dashboard --- */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        @media(min-width: 992px) { .dashboard { grid-template-columns: 1fr 1fr; } }

        /* --- Cards --- */
        .card {
            background: var(--glass-bg);
            padding: 24px;
            border-radius: var(--card-radius);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(16px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .card-tag {
            font-size: 11px;
            background: linear-gradient(90deg, var(--primary), #818cf8);
            padding: 4px 10px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
        }

        /* --- Controls --- */
        .strategy-control-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .control-row { display: flex; gap: 12px; align-items: stretch; }

        .select-wrapper {
            flex-grow: 2;
            position: relative;
        }
        
        .strategy-select {
            width: 100%;
            appearance: none;
            -webkit-appearance: none;
            background: #1e293b;
            border: 1px solid #475569;
            color: white;
            padding: 12px 16px;
            padding-right: 40px;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .strategy-select:hover { border-color: var(--primary); background: #334155; }
        .strategy-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25); }

        .select-arrow {
            position: absolute; top: 50%; right: 15px; transform: translateY(-50%);
            width: 12px; height: 12px; pointer-events: none;
            border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #94a3b8;
        }

        .unit-input-group {
            display: flex; align-items: center; gap: 10px;
            background: #1e293b; border: 1px solid #475569; padding: 4px 12px;
            border-radius: 8px; transition: all 0.3s;
        }
        .unit-input-group:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25); }

        .unit-label { font-size: 13px; color: #cbd5e1; white-space: nowrap; font-weight: 500; }
        .unit-input {
            width: 50px; background: transparent; border: none; color: var(--warning);
            font-weight: 700; font-size: 16px; text-align: center; outline: none; padding: 8px 0;
        }
        .unit-input::-webkit-outer-spin-button, .unit-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .btn-switch {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; border: none; padding: 0 20px; border-radius: 8px;
            cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.3s;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); white-space: nowrap;
        }
        .btn-switch:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4); }
        .btn-switch:active { transform: translateY(0); }

        /* --- Stats --- */
        .strategy-box {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
        }
        .strategy-title {
            font-size: 13px; color: var(--text-muted); margin-bottom: 12px;
            text-align: center; text-transform: uppercase; letter-spacing: 1px;
        }
        .strategy-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        @media(max-width: 600px) { .strategy-grid { grid-template-columns: repeat(2, 1fr); } }
        .stat-item {
            background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px;
            text-align: center; transition: transform 0.2s;
        }
        .stat-item:hover { transform: translateY(-2px); background: rgba(255,255,255,0.05); }
        .stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-value { font-size: 16px; font-weight: 700; color: white; }
        .val-win { color: var(--success); text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .val-loss { color: var(--danger); text-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }

        /* --- Prediction --- */
        .last-bet-info {
            text-align: center; font-size: 13px; color: var(--text-muted); margin-bottom: 15px;
            background: rgba(255,255,255,0.03); padding: 6px; border-radius: 20px;
            display: inline-block; width: 100%;
        }
        .signal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .signal-btn {
            padding: 15px; border-radius: 12px; text-align: center; font-size: 14px; font-weight: 700;
            background: rgba(30, 41, 59, 0.5); color: #64748b; border: 1px solid transparent;
            transition: all 0.3s; position: relative; overflow: hidden;
        }
        .signal-btn.active {
            color: white; border: 1px solid rgba(255,255,255,0.5); transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .sig-super.active { background: linear-gradient(135deg, #f97316, #ef4444); }
        .sig-strong.active { background: linear-gradient(135deg, #10b981, #06b6d4); }
        .sig-weak.active { background: linear-gradient(135deg, #64748b, #475569); }
        .sig-stop.active { background: linear-gradient(135deg, #475569, #1e293b); color: #ef4444; }

        .sniper-balls { display: flex; justify-content: center; gap: 24px; margin: 24px 0; }
        .s-ball {
            width: 64px; height: 64px; line-height: 64px; border-radius: 50%; font-size: 26px; font-weight: 800;
            background: radial-gradient(circle at 30% 30%, #d8b4fe, #7c3aed); color: white; text-align: center;
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.4), 0 0 20px rgba(124, 58, 237, 0.6);
            border: 2px solid rgba(255,255,255,0.3); text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .s-label { font-size: 12px; color: var(--text-muted); margin-top: 8px; text-align: center; }

        /* --- History --- */
        .full-history-card { grid-column: 1 / -1; }
        .history-table-container { overflow-x: auto; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .full-history-table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
        .full-history-table th {
            background: rgba(30, 41, 59, 0.9); padding: 14px; color: var(--text-muted);
            font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.05);
        }
        .full-history-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); text-align: center; color: #e2e8f0; }
        .full-history-table tr:hover { background: rgba(255,255,255,0.02); }

        .num-ball {
            display: inline-block; width: 24px; height: 24px; line-height: 24px; border-radius: 50%;
            font-size: 12px; margin: 0 2px; color: #94a3b8; background: #1e293b; font-weight: bold;
        }
        .num-hit-0 { background: #ef4444; color: white; box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); }
        .num-hit-1 { background: #f59e0b; color: black; box-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }
        .num-hit-2 { background: #06b6d4; color: white; box-shadow: 0 0 8px rgba(6, 182, 212, 0.4); }

        .res-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 800; letter-spacing: 0.5px; }
        .badge-win { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-loss { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); opacity: 0.8; }

        .pagination { display: flex; justify-content: center; gap: 15px; margin-top: 20px; align-items: center; }
        .page-btn { background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .page-btn:hover:not(:disabled) { background: var(--primary); }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .btn-fetch {
            background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; border: none;
            padding: 14px; width: 100%; border-radius: 10px; font-size: 16px; font-weight: 700;
            cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center;
            gap: 10px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .btn-fetch:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5); }

        .progress-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); z-index: 10; display: none; justify-content: center;
            align-items: center; flex-direction: column; backdrop-filter: blur(5px);
        }
        .progress-bar-bg { width: 60%; height: 6px; background: #334155; border-radius: 10px; overflow: hidden; margin-top: 15px; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.3s; }

        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes blink { 50% { opacity: 0.5; } }

        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 10px; }
        
        #manualInputSection { display: none; margin-top: 10px; padding: 15px; background: linear-gradient(135deg, #ef4444, #991b1b); border-radius: 8px; text-align: center; }

        /* --- CUSTOM MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 9999;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        
        .modal-box {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px; border-radius: 20px;
            width: 90%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.show .modal-box { transform: scale(1); }

        .modal-icon { font-size: 40px; margin-bottom: 15px; }
        .modal-title { font-size: 20px; font-weight: 700; color: white; margin-bottom: 10px; }
        .modal-msg { font-size: 14px; color: #cbd5e1; margin-bottom: 25px; line-height: 1.6; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { flex: 1; padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .modal-btn-cancel { background: #334155; color: white; }
        .modal-btn-cancel:hover { background: #475569; }
        .modal-btn-confirm { background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; }
        .modal-btn-confirm:hover { box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); transform: translateY(-2px); }
        .modal-btn-ok { background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; }
        .modal-btn-ok:hover { box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); transform: translateY(-2px); }

    </style>
</head>
<body class="mode-a">

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <div id="modalIcon" class="modal-icon">âš ï¸</div>
        <div id="modalTitle" class="modal-title">æ¨™é¡Œ</div>
        <div id="modalMsg" class="modal-msg">å…§å®¹</div>
        <div id="modalActions" class="modal-actions"></div>
    </div>
</div>

<div class="container">
    <header>
        <h1 id="app-title">Lotto 539 Trading System</h1>
    </header>

    <div class="mode-switcher">
        <button class="mode-btn active" id="btnModeA" onclick="setMode('A')">ç©æ³• Aï¼šè°æ˜åŒ…ç‰Œ</button>
        <button class="mode-btn" id="btnModeB" onclick="setMode('B')">ç©æ³• Bï¼šç¨æ”¯ Sniper</button>
    </div>

    <div class="status-container">
        <div class="status-bar-content">
            <div class="status-text-group">
                <div id="statusText" class="loading">â³ ç³»çµ±å•Ÿå‹•ä¸­...</div>
                <div class="data-info-block" id="dataInfoBlock">
                    <span style="opacity:0.5;">ç­‰å¾…è¼‰å…¥...</span>
                </div>
            </div>
            
            <button class="btn-reset" onclick="resetAndReloadData()" id="btnResetData">
                ğŸ”„ é‡æ–°é©—è­‰æ•¸æ“š
            </button>
        </div>
        <div class="status-progress-bar">
            <div class="status-progress-fill" id="statusProgressBar"></div>
        </div>
    </div>

    <div id="manualInputSection">
        <p style="color:white; font-weight:bold;">âš ï¸ è‡ªå‹•æ›´æ–°å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æœ€æ–°ä¸€æœŸè™Ÿç¢¼ï¼š</p>
        <input type="number" class="manual-input" id="m1">
        <input type="number" class="manual-input" id="m2">
        <input type="number" class="manual-input" id="m3">
        <input type="number" class="manual-input" id="m4">
        <input type="number" class="manual-input" id="m5">
        <button onclick="manualStart()" style="padding:5px 15px; cursor:pointer; color:black; background:white; border:none; border-radius:4px; font-weight:bold;">ç¢ºèª</button>
    </div>

    <div class="dashboard">
        <div class="card" id="card-backtest">
            <h2>
                <span>ğŸ’° ç­–ç•¥å›æ¸¬å ±å‘Š</span>
                <span class="card-tag" id="current-strategy-tag">New Sniper</span>
            </h2>
            
            <div class="strategy-control-panel">
                <div class="control-row">
                    <div class="select-wrapper">
                        <select id="strategySelect" class="strategy-select"></select>
                        <div class="select-arrow"></div>
                    </div>
                </div>
                <div class="control-row">
                    <div class="unit-input-group">
                        <span class="unit-label">åŸºæœ¬å–®ä½ ($):</span>
                        <input type="number" id="baseUnit" class="unit-input" value="1" min="1">
                    </div>
                    <button class="btn-switch" onclick="runAnalysisWithLoading()">åˆ‡æ› / è¨ˆç®—</button>
                </div>
            </div>

            <div class="progress-overlay" id="loadingBar">
                <div style="color:white; font-weight:bold; font-size:16px;">AI é‹ç®—ä¸­...</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
            </div>
            
            <div class="strategy-box" id="strategyBox">
                <div class="strategy-title">
                    ğŸ“Š æ­·å²ç¸¾æ•ˆ (å…± <span id="real-test-count-disp" style="color:var(--primary);">--</span> æœŸ)
                </div>
                <div class="strategy-grid">
                    <div class="stat-item">
                        <div class="stat-label">ç´¯ç©æ·¨åˆ© (Net)</div>
                        <div class="stat-value val-win" id="st-profit">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æŠ•è³‡å ±é…¬ç‡ (ROI)</div>
                        <div class="stat-value val-win" id="st-roi">--%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å‹ç‡ (Win Rate)</div>
                        <div class="stat-value" id="st-winrate">--%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ç¸½ä¸‹æ³¨å–®æ•¸</div>
                        <div class="stat-value" id="st-count" style="color:#f472b6;">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€é«˜é€£å‹</div>
                        <div class="stat-value val-win" id="st-max-win">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€é«˜é€£æ•—</div>
                        <div class="stat-value val-loss" id="st-max-loss">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€å¤§å›æ’¤ (MDD)</div>
                        <div class="stat-value val-loss" id="st-mdd">--</div>
                    </div>
                    <div class="stat-item" style="opacity:0.6;">
                         <div class="stat-label">å€ç‡è¨­å®š</div>
                         <div class="stat-value" id="st-unit">1</div>
                    </div>
                </div>
                <div id="strategy-desc" style="font-size:12px; color:var(--text-muted); margin-top:15px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.1);">
                    --
                </div>
            </div>
        </div>

        <div class="card">
            <h2>
                <span>ğŸ”® ä¸‹ä¸€æœŸæ“ç›¤å»ºè­°</span>
                <span class="card-tag" style="background:#ec4899;">Signal</span>
            </h2>
            
            <div class="last-bet-info">
                ğŸ“… æœ€å¾Œè¨Šè™Ÿæ—¥: <span id="last-bet-date" style="color:var(--primary); font-weight:bold;">--/--</span>
            </div>

            <div style="text-align:center; padding:15px 0;">
                <div style="font-size:14px; color:var(--text-muted); margin-bottom:5px;">é æ¸¬é–‹çæ—¥</div>
                <div id="nextDrawDate" style="font-size:24px; font-weight:800; color:white; text-shadow:0 0 15px rgba(255,255,255,0.2);">--/--</div>
                <div id="nextWeekday" style="font-size:16px; color:var(--secondary); margin-top:4px; font-weight:bold;">é€±--</div>
            </div>

            <div id="prediction-panel">
                <div id="panel-mode-a" style="display:block;">
                    <div class="signal-grid">
                        <div id="btn-super" class="signal-btn sig-super">ğŸ”¥ å¼·åŠ›è¨Šè™Ÿ<br><span style="font-size:11px; font-weight:normal; opacity:0.8;">2å€ / ç¿»å€</span></div>
                        <div id="btn-strong" class="signal-btn sig-strong">âš¡ é›™é‚Šè¨Šè™Ÿ<br><span style="font-size:11px; font-weight:normal; opacity:0.8;">P1 & P2</span></div>
                        <div id="btn-weak" class="signal-btn sig-weak">â„ï¸ æ¨™æº–è¨Šè™Ÿ<br><span style="font-size:11px; font-weight:normal; opacity:0.8;">1å€ P1</span></div>
                        <div id="btn-stop" class="signal-btn sig-stop">ğŸ›‘ æš«åœ/é¢¨éšª<br><span style="font-size:11px; font-weight:normal; opacity:0.8;">æ¿¾ç¶²æœªé</span></div>
                    </div>
                    <div class="strategy-box" style="background: rgba(0,0,0,0.3); border-color:var(--primary-glow);">
                        <div class="strategy-title" style="color:#ddd; justify-content:center;">
                            æ¨è–¦çµ„åˆ (Package)
                        </div>
                        <div style="text-align:center; margin-top:10px;">
                            <div style="font-size:22px; font-weight:bold; color:var(--warning); text-shadow:0 0 10px rgba(245,158,11,0.4);" id="pred-combo">--</div>
                            <div style="font-size:13px; color:var(--text-muted); margin-top:8px;" id="pred-desc">--</div>
                        </div>
                    </div>
                </div>

                <div id="panel-mode-b" style="display:none;">
                    <div id="sniper-status" style="text-align:center; font-size:16px; font-weight:bold; margin-bottom:15px; color:var(--text-muted);">
                        æª¢æ¸¬è¨Šè™Ÿä¸­...
                    </div>
                    <div class="sniper-balls" id="sniper-balls-container" style="display:none;">
                        <div class="s-ball-box">
                            <div class="s-ball" id="ball-1">--</div>
                            <div class="s-label">ç¬¬ä¸€ç†±é–€</div>
                        </div>
                        <div class="s-ball-box">
                            <div class="s-ball" id="ball-2">--</div>
                            <div class="s-label">ç¬¬äºŒç†±é–€</div>
                        </div>
                    </div>
                    <div class="strategy-box" style="border-color:var(--secondary); background:rgba(236, 72, 153, 0.1);">
                         <div style="text-align:center; font-size:14px; color:#ddd;">
                             ğŸ¯ <b>Sniper-6 ç­–ç•¥è¦å‰‡</b><br>
                             <span style="font-size:12px; color:#aaa;">è¿‘15æœŸæ¦œé¦–å‰›å¥½å‡ºç¾6æ¬¡ â¡ é€²å ´</span><br>
                             <span style="font-size:12px; color:#aaa; margin-top:5px; display:inline-block;">æˆæœ¬: $5,700 / çé‡‘: $21,200</span>
                         </div>
                    </div>
                </div>
            </div>
            
            <button id="btnFetch" class="btn-fetch" onclick="forceFetchData()">
                <span id="fetchIcon">ğŸ”„</span> 
                <span id="fetchText">æ‰‹å‹•æŠ“å–æœ€æ–°æ•¸æ“š</span>
            </button>
        </div>
        
        <div class="card full-history-card">
            <h2>
                <span>ğŸ“œ è©³ç´°ä¸‹æ³¨æ­·å²ç´€éŒ„</span>
                <span class="card-tag">History</span>
            </h2>
            <div class="history-table-container">
                <table class="full-history-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é–‹çè™Ÿç¢¼</th>
                            <th>è¨Šè™Ÿ/é æ¸¬</th>
                            <th>ä¸‹æ³¨é‡‘é¡</th>
                            <th>æ·¨æç›Š</th>
                            <th>çµæœ</th>
                        </tr>
                    </thead>
                    <tbody id="fullHistoryBody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="page-btn" onclick="changePage(-1)">â—€ ä¸Šä¸€é </button>
                <span class="page-info" id="pageInfo">ç¬¬ 1 / 1 é </span>
                <button class="page-btn" onclick="changePage(1)">ä¸‹ä¸€é  â–¶</button>
            </div>
        </div>
        
        <div class="card full-history-card">
            <h2>
                <span>ğŸ“ˆ è³‡é‡‘æ¬Šç›Šèµ°å‹¢åœ–</span>
                <span class="card-tag" style="background:#10b981;">Equity Curve</span>
            </h2>
            <div class="chart-container">
                <canvas id="equityChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        // ==========================================
        //  è¨­å®šå€ï¼šæ‚¨çš„ Google Drive æª”æ¡ˆ ID
        // ==========================================
        const DRIVE_FILE_ID = '1K2CNRIE97NRfJrzKiG8Adcz_tFeYHPlm';
        
        // æ ¸å¿ƒåƒæ•¸
        let fullData = [];
        let currentMode = 'A'; 
        let currentStrategyA = 'sniper_new'; 
        let globalTradeHistory = []; 
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;
        
        const STORAGE_KEY = 'lotto539_data_cache_v8_cloud'; 
        const CRAWL_PAGES = 3; 
        const BASE_URL = "https://www.lotto-8.com/listlto539.asp";
        
        const COST_PER_BET_A = 1062;
        const PRIZE_3 = 1710;
        const PRIZE_4 = 2280;
        
        const COST_PER_BET_B = 5700; 
        const PRIZE_B = 21200;

        const HEADS = {
            0: [1,2,3,4,5,6,7,8,9],
            1: [11,12,13,14,15,16,17,18,19],
            2: [21,22,23,24,25,26,27,28,29],
            3: [31,32,33,34,35,36,37,38,39]
        };
        
        let equityChartInstance = null;

        window.onload = initSystem;

        function setStatus(text, type = 'loading') {
            const el = document.getElementById('statusText');
            el.innerText = text;
            el.className = type;
            
            const bar = document.getElementById('statusProgressBar');
            if (type === 'loading' || type === 'syncing') {
                bar.classList.add('indeterminate');
            } else {
                bar.classList.remove('indeterminate');
                bar.style.width = '100%';
                setTimeout(() => { bar.style.width = '0%'; }, 1000);
            }
        }

        // --- Custom Modal Helper ---
        function showModal(type, title, msg) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const icon = document.getElementById('modalIcon');
                const titleEl = document.getElementById('modalTitle');
                const msgEl = document.getElementById('modalMsg');
                const actionsEl = document.getElementById('modalActions');
                
                titleEl.innerText = title;
                msgEl.innerText = msg;
                msgEl.innerHTML = msg.replace(/\n/g, '<br>');

                actionsEl.innerHTML = ''; 

                if (type === 'confirm') {
                    icon.innerText = 'âš ï¸';
                    
                    const btnCancel = document.createElement('button');
                    btnCancel.className = 'modal-btn modal-btn-cancel';
                    btnCancel.innerText = 'å–æ¶ˆ';
                    btnCancel.onclick = () => {
                        modal.classList.remove('show');
                        setTimeout(() => { modal.style.display = 'none'; }, 300);
                        resolve(false);
                    };
                    
                    const btnConfirm = document.createElement('button');
                    btnConfirm.className = 'modal-btn modal-btn-confirm';
                    btnConfirm.innerText = 'ç¢ºå®šé‡ç½®';
                    btnConfirm.onclick = () => {
                        modal.classList.remove('show');
                        setTimeout(() => { modal.style.display = 'none'; }, 300);
                        resolve(true);
                    };
                    
                    actionsEl.appendChild(btnCancel);
                    actionsEl.appendChild(btnConfirm);
                } else {
                    icon.innerText = type === 'error' ? 'âŒ' : 'âœ…';
                    const btnOk = document.createElement('button');
                    btnOk.className = 'modal-btn modal-btn-ok';
                    btnOk.innerText = 'å¥½';
                    btnOk.onclick = () => {
                        modal.classList.remove('show');
                        setTimeout(() => { modal.style.display = 'none'; }, 300);
                        resolve(true);
                    };
                    actionsEl.appendChild(btnOk);
                }

                modal.style.display = 'flex';
                void modal.offsetWidth;
                modal.classList.add('show');
            });
        }

        async function fetchCloudData() {
            setStatus("â˜ï¸ æ­£åœ¨ä¸‹è¼‰é›²ç«¯æ­·å²æ•¸æ“š...", 'syncing');

            const driveUrl = `https://drive.google.com/uc?export=download&id=${DRIVE_FILE_ID}`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(driveUrl)}`;

            try {
                let res = await fetch(proxyUrl);
                if (!res.ok) throw new Error("Network response was not ok");
                let data = await res.json();
                console.log("é›²ç«¯æ•¸æ“šä¸‹è¼‰æˆåŠŸï¼Œå…±", data.length, "ç­†");
                return data;
            } catch (error) {
                console.error("é›²ç«¯ä¸‹è¼‰å¤±æ•—:", error);
                setStatus("âš ï¸ é›²ç«¯ä¸‹è¼‰å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°/çˆ¬èŸ²", 'loading');
                return []; 
            }
        }

        async function initSystem() {
            let cloudData = await fetchCloudData();
            
            let localData = [];
            const localStr = localStorage.getItem(STORAGE_KEY);
            if (localStr) {
                try { localData = JSON.parse(localStr); } catch(e) {}
            }

            let mergedMap = new Map();
            if (Array.isArray(cloudData)) cloudData.forEach(item => mergedMap.set(item.date, item));
            if (Array.isArray(localData)) localData.forEach(item => mergedMap.set(item.date, item));

            fullData = Array.from(mergedMap.values());
            fullData.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
            
            updateStrategyOptions(); 
            runAnalysisWithLoading();

            await forceFetchData(); 
        }

        async function resetAndReloadData() {
            const confirmed = await showModal('confirm', 'è³‡æ–™é‡ç½®ç¢ºèª', 'æ‚¨ç¢ºå®šè¦åŸ·è¡Œã€Œé‡æ–°é©—è­‰ã€å—ï¼Ÿ\n\né€™å°‡æœƒåˆªé™¤å¿«å–ã€é‡æ–°ä¸‹è¼‰é›²ç«¯æª”æ¡ˆä¸¦è£œé½Šæœ€æ–°æ•¸æ“šã€‚');
            
            if (!confirmed) return;

            const btn = document.getElementById('btnResetData');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "â³ é‡ç½®ä¸­...";
            
            setStatus("â™»ï¸ æ¸…é™¤å¿«å–ä¸¦é‡æ–°åŒæ­¥ä¸­...", 'syncing');

            try {
                localStorage.removeItem(STORAGE_KEY);
                fullData = []; 

                let cloudData = await fetchCloudData();

                let mergedMap = new Map();
                if (Array.isArray(cloudData)) {
                    cloudData.forEach(item => mergedMap.set(item.date, item));
                }
                
                fullData = Array.from(mergedMap.values());
                fullData.sort((a,b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));

                runAnalysisWithLoading();
                await forceFetchData();

                await showModal('success', 'é‡ç½®å®Œæˆ', 'æ•¸æ“šå·²æ›´æ–°è‡³æœ€æ–°ç‹€æ…‹ï¼');

            } catch (e) {
                console.error(e);
                await showModal('error', 'é‡ç½®å¤±æ•—', 'éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥ã€‚');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function forceFetchData() {
            const btn = document.getElementById('btnFetch');
            
            if(btn) {
                btn.disabled = true;
                btn.querySelector('#fetchText').innerText = "è‡ªå‹•æ›´æ–°ä¸­...";
                btn.querySelector('#fetchIcon').classList.add('spin');
            }
            setStatus("ğŸ“¡ èƒŒæ™¯åŒæ­¥æ–°è³‡æ–™...", 'syncing');

            const proxies = [
                url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&timestamp=${Date.now()}`,
                url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];

            let latestDate = (fullData.length > 0) ? fullData[0].date : "2000/01/01";
            let newData = [];
            let stop = false;

            try {
                for (let i = 1; i <= CRAWL_PAGES; i++) {
                    if (stop) break;
                    let targetUrl = i === 1 ? BASE_URL : `${BASE_URL}?indexpage=${i}&orderby=new`;
                    let html = null;

                    for (let attempt = 0; attempt < 3; attempt++) {
                        for (let proxy of proxies) {
                            try {
                                let res = await fetch(proxy(targetUrl));
                                let content = res.url.includes("allorigins") ? (await res.json()).contents : await res.text();
                                if (content && content.length > 500) { html = content; break; }
                            } catch(e) {}
                        }
                        if (html) break;
                        await new Promise(r => setTimeout(r, 1000));
                    }

                    if (html) {
                        let parsed = parseHtml(html);
                        for (let row of parsed) {
                            if (new Date(row.date) > new Date(latestDate)) {
                                newData.push(row);
                            } else {
                                stop = true; 
                            }
                        }
                    }
                }

                if (newData.length > 0) {
                    fullData = [...newData, ...fullData];
                    fullData.sort((a,b) => new Date(b.date) - new Date(a.date));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
                    setStatus(`âœ… å·²æ›´æ–° ${newData.length} ç­†æ–°è³‡æ–™`, 'success');
                    runAnalysisWithLoading(); 
                } else {
                    setStatus("âœ… è³‡æ–™å·²æ˜¯æœ€æ–°", 'success');
                }

            } catch (e) {
                setStatus("âš ï¸ é€£ç·šé€¾æ™‚ (ä½¿ç”¨å¿«å–/é›²ç«¯)", 'loading');
            }

            if(btn) {
                btn.disabled = false;
                btn.querySelector('#fetchText').innerText = "æ‰‹å‹•å¼·åˆ¶æ›´æ–°";
                btn.querySelector('#fetchIcon').classList.remove('spin');
            }
        }

        function parseHtml(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            let results = [];
            doc.querySelectorAll("tr").forEach(row => {
                const text = row.innerText.trim();
                const dMatch = text.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
                if (dMatch) {
                    let nums = text.match(/\d{2}/g);
                    if (nums && nums.length >= 5) {
                        let valid = [];
                        for (let i = nums.length - 1; i >= 0; i--) {
                            let n = parseInt(nums[i]);
                            if (n >= 1 && n <= 39 && !valid.includes(n)) valid.unshift(n);
                            if (valid.length === 5) break;
                        }
                        let dateStr = `${dMatch[1]}/${dMatch[2].padStart(2, '0')}/${dMatch[3].padStart(2, '0')}`;
                        if (valid.length === 5) results.push({ date: dateStr, numbers: valid });
                    }
                }
            });
            return results;
        }

        async function manualStart() {
            let inputs = [1,2,3,4,5].map(i => parseInt(document.getElementById('m'+i).value));
            if(inputs.some(isNaN)) {
                await showModal('error', 'è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥å®Œæ•´çš„ 5 å€‹è™Ÿç¢¼ï¼');
                return;
            }
            
            let today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
            fullData.unshift({ date: today, numbers: inputs });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
            document.getElementById('manualInputSection').style.display = 'none';
            runAnalysisWithLoading();
        }

        function setMode(mode) {
            currentMode = mode;
            document.body.className = mode === 'A' ? 'mode-a' : 'mode-b';
            document.getElementById('btnModeA').className = mode === 'A' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btnModeB').className = mode === 'B' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('panel-mode-a').style.display = mode === 'A' ? 'block' : 'none';
            document.getElementById('panel-mode-b').style.display = mode === 'B' ? 'block' : 'none';
            
            updateStrategyOptions();
            runAnalysisWithLoading();
        }

        function updateStrategyOptions() {
            const select = document.getElementById('strategySelect');
            select.innerHTML = '';
            if (currentMode === 'A') {
                const opts = [
                    {val: 'sniper_new', text: '1. ğŸ¥‡ ç¥å°„æ‰‹ (New Sniper)'},
                    {val: 'shield_new', text: '2. ğŸ›¡ï¸ å …ç›¾é˜²ç¦¦ (New Shield)'},
                    {val: 'peak_martingale', text: '3. ğŸ’€ æ¥µé™å‡¹å–® (Peak Martingale)'}
                ];
                opts.forEach(o => {
                    let el = document.createElement('option');
                    el.value = o.val; el.text = o.text;
                    select.add(el);
                });
                select.value = currentStrategyA;
                select.disabled = false;
            } else {
                let el = document.createElement('option');
                el.value = 'sniper'; el.text = 'Sniper-6 ç²¾æº–ç¨æ”¯ (Original)';
                select.add(el);
                select.disabled = true;
            }
        }

        function runAnalysisWithLoading() {
            const loading = document.getElementById('loadingBar');
            const fill = document.getElementById('progressFill');
            const select = document.getElementById('strategySelect');
            
            if (currentMode === 'A') currentStrategyA = select.value;
            
            loading.style.display = 'flex';
            fill.style.width = '0%';
            
            setTimeout(() => { fill.style.width = '60%'; }, 200);
            
            setTimeout(() => { 
                fill.style.width = '100%';
                
                // UPDATE DATA RANGE DISPLAY
                const infoBlock = document.getElementById('dataInfoBlock');
                if (fullData.length > 0) {
                    const firstDate = fullData[fullData.length - 1].date;
                    const lastDate = fullData[0].date;
                    infoBlock.innerHTML = 
                        `<div class="data-range-date">${firstDate} ~ ${lastDate}</div>
                         <div class="data-count-highlight">åº«å­˜: ${fullData.length} æœŸ</div>`;
                } else {
                    infoBlock.innerHTML = '<span style="opacity:0.5">ç„¡æ•¸æ“š</span>';
                }
                
                const unit = parseFloat(document.getElementById('baseUnit').value) || 1;
                
                // === FIXED: RESTORED PREDICTION CALL ===
                predictNextDraw(); 
                
                let res;
                if (currentMode === 'A') {
                    res = runPackageBacktest(fullData, currentStrategyA, unit);
                } else {
                    res = runSniperBacktest(fullData, unit);
                }
                
                updateStatBox(res);
                currentPage = 1;
                renderFullHistoryTable();
                
                updateEquityChart();
                
                if (currentMode === 'A') {
                    const tagName = select.options[select.selectedIndex].text.split('(')[1].split(')')[0];
                    document.getElementById('current-strategy-tag').innerText = tagName;
                } else {
                    document.getElementById('current-strategy-tag').innerText = "Sniper-6 (Original)";
                }
                
                setTimeout(() => { loading.style.display = 'none'; }, 200);
            }, 500);
        }

        function runPackageBacktest(data, strategy, baseUnit) {
            let totalCost = 0, totalPrize = 0;
            let winDays = 0, tradingDays = 0, totalBetUnits = 0;
            let currentWin = 0, maxWin = 0, currentLoss = 0, maxLoss = 0;
            let currentEquity = 0, peakEquity = 0, maxDrawdown = 0;
            let lastBetDate = "ç„¡";
            
            let peakMartingaleMult = 1;
            let lastTradeWon = false; 

            globalTradeHistory = []; 

            if(data.length < 22) return { cost: 0, net: 0, winDays: 0, tradingDays: 0, totalBetUnits:0, maxWin:0, maxLoss:0, maxDrawdown:0 };

            for(let i = data.length - 21; i >= 0; i--) {
                let targetDraw = data[i]; 
                let past20 = data.slice(i+1, i+21);
                let counts = getHeadCounts(past20);
                
                let others = {1: counts[1], 2: counts[2], 3: counts[3]};
                let sortedHeads = Object.keys(others).sort((a,b) => others[b] - others[a]);
                let p1 = parseInt(sortedHeads[0]);
                let p2 = parseInt(sortedHeads[1]);
                let gap = others[p1] - others[p2];
                let count0 = counts[0];
                
                let date = new Date(targetDraw.date);
                let day = date.getDay(); 
                
                let isTradeDay = false;

                if (strategy === 'sniper_new' || strategy === 'peak_martingale') {
                    isTradeDay = (day !== 2 && count0 <= 25);
                } else if (strategy === 'shield_new') {
                    isTradeDay = (day !== 2 && day !== 3 && count0 <= 22);
                }
                
                let betUnits = 0; 
                let dailyPrize = 0;
                let signalText = "";
                let isWin = false;

                if (isTradeDay) {
                    if (strategy === 'peak_martingale') {
                        if (currentEquity >= peakEquity) {
                            peakMartingaleMult = 1; 
                        } else {
                            if (!lastTradeWon) {
                                peakMartingaleMult = Math.min(peakMartingaleMult * 2, 16);
                            } 
                        }

                        betUnits = peakMartingaleMult;
                        let cost = betUnits * COST_PER_BET_A * baseUnit;
                        let prize = checkPrizeA(targetDraw.numbers, 0, p1) * betUnits * baseUnit;
                        
                        totalCost += cost;
                        dailyPrize += prize;
                        signalText = `0+${p1} (${peakMartingaleMult}å€)`;
                        
                        isWin = prize > cost;
                        lastTradeWon = isWin;

                    } else {
                        if (gap >= 6) {
                            betUnits = 2; 
                            dailyPrize += checkPrizeA(targetDraw.numbers, 0, p1) * 2 * baseUnit;
                            signalText = `0+${p1} (x2)`;
                        } else if (gap <= 2) {
                            betUnits = 2; 
                            dailyPrize += checkPrizeA(targetDraw.numbers, 0, p1) * baseUnit;
                            dailyPrize += checkPrizeA(targetDraw.numbers, 0, p2) * baseUnit;
                            signalText = `0+${p1}&${p2}`;
                        } else {
                            betUnits = 1; 
                            dailyPrize += checkPrizeA(targetDraw.numbers, 0, p1) * baseUnit;
                            signalText = `0+${p1}`;
                        }
                        let cost = betUnits * COST_PER_BET_A * baseUnit;
                        totalCost += cost;
                        isWin = dailyPrize > cost;
                    }

                    tradingDays++;
                    totalBetUnits += betUnits; 
                    totalPrize += dailyPrize;

                    let costThisRound = (strategy === 'peak_martingale') ? (peakMartingaleMult * COST_PER_BET_A * baseUnit) : (betUnits * COST_PER_BET_A * baseUnit);
                    currentEquity += (dailyPrize - costThisRound);
                    
                    if(currentEquity > peakEquity) peakEquity = currentEquity;
                    let dd = currentEquity - peakEquity;
                    if(dd < maxDrawdown) maxDrawdown = dd;
                    
                    if (isWin) {
                        winDays++;
                        currentWin++;
                        currentLoss = 0;
                        if(currentWin > maxWin) maxWin = currentWin;
                    } else {
                        currentLoss++;
                        currentWin = 0;
                        if(currentLoss > maxLoss) maxLoss = currentLoss;
                    }
                    lastBetDate = targetDraw.date;

                    globalTradeHistory.push({
                        date: targetDraw.date,
                        numbers: targetDraw.numbers,
                        signal: signalText,
                        cost: costThisRound,
                        net: dailyPrize - costThisRound,
                        isWin: isWin,
                        heads: {p1, p2} 
                    });
                }
            }
            
            globalTradeHistory.reverse();

            document.getElementById('last-bet-date').innerText = lastBetDate;
            let desc = "";
            if(strategy==='sniper_new') desc = "Sniper: é¿é€±äºŒï¼ŒGap>=6é‡æ³¨ï¼Œ<=2é›™é¾ã€‚";
            if(strategy==='shield_new') desc = "Shield: é¿é€±äºŒä¸‰ï¼Œåš´æ ¼éç†±æ¿¾ç¶²ã€‚";
            if(strategy==='peak_martingale') desc = "Peak: è³‡é‡‘å‰µé«˜å‰ï¼Œè¼¸å‰‡ç¿»å€è´å‰‡è¿½æ“Šã€‚";
            document.getElementById('strategy-desc').innerText = desc;

            return { cost: totalCost, net: totalPrize - totalCost, winDays, tradingDays, totalBetUnits, maxWin, maxLoss, maxDrawdown };
        }

        function runSniperBacktest(data, baseUnit) {
            let totalCost = 0, totalPrize = 0;
            let winDays = 0, tradingDays = 0, totalBetUnits = 0;
            let currentWin = 0, maxWin = 0, currentLoss = 0, maxLoss = 0;
            let currentEquity = 0, peakEquity = 0, maxDrawdown = 0;
            let lastBetDate = "ç„¡";
            
            globalTradeHistory = [];

            if(data.length < 16) return { cost: 0, net: 0, winDays: 0, tradingDays: 0, totalBetUnits:0, maxWin:0, maxLoss:0, maxDrawdown:0 };

            for(let i = data.length - 16; i >= 0; i--) {
                let targetDraw = data[i];
                let past15 = data.slice(i+1, i+16);
                
                let numCounts = {};
                for(let k=1; k<=39; k++) numCounts[k] = 0;
                past15.forEach(d => {
                    d.numbers.forEach(n => numCounts[n]++);
                });
                
                let sortedNums = Object.keys(numCounts).sort((a,b) => {
                    let diff = numCounts[b] - numCounts[a];
                    if (diff !== 0) return diff;
                    return parseInt(a) - parseInt(b); 
                });
                
                let top1 = parseInt(sortedNums[0]);
                let top2 = parseInt(sortedNums[1]);
                let top1_count = numCounts[top1];

                if (top1_count === 6) {
                    tradingDays++;
                    totalBetUnits += 2; 
                    
                    let cost = COST_PER_BET_B * baseUnit; 
                    let dailyPrize = 0;
                    
                    if (targetDraw.numbers.includes(top1)) dailyPrize += PRIZE_B * baseUnit;
                    if (targetDraw.numbers.includes(top2)) dailyPrize += PRIZE_B * baseUnit;
                    
                    totalCost += cost;
                    totalPrize += dailyPrize;

                    currentEquity += (dailyPrize - cost);
                    if(currentEquity > peakEquity) peakEquity = currentEquity;
                    let dd = currentEquity - peakEquity;
                    if(dd < maxDrawdown) maxDrawdown = dd;
                    
                    let isWin = dailyPrize > cost;

                    if (isWin) {
                        winDays++;
                        currentWin++;
                        currentLoss = 0;
                        if(currentWin > maxWin) maxWin = currentWin;
                    } else {
                        currentLoss++;
                        currentWin = 0;
                        if(currentLoss > maxLoss) maxLoss = currentLoss;
                    }
                    lastBetDate = targetDraw.date;
                    
                    globalTradeHistory.push({
                        date: targetDraw.date,
                        numbers: targetDraw.numbers,
                        signal: `${top1}, ${top2}`,
                        cost: cost,
                        net: dailyPrize - cost,
                        isWin: isWin,
                        targets: [top1, top2] 
                    });
                }
            }
            
            globalTradeHistory.reverse();

            document.getElementById('last-bet-date').innerText = lastBetDate;
            document.getElementById('strategy-desc').innerText = "Sniper-6 (Original): è¿‘15æœŸæ¦œé¦–å‰›å¥½6æ¬¡æ™‚ï¼Œè²·å‰2ç†±è™Ÿã€‚";
            
            return { cost: totalCost, net: totalPrize - totalCost, winDays, tradingDays, totalBetUnits, maxWin, maxLoss, maxDrawdown };
        }

        function changePage(delta) {
            const totalPages = Math.ceil(globalTradeHistory.length / ITEMS_PER_PAGE);
            let newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderFullHistoryTable();
            }
        }

        function renderFullHistoryTable() {
            const tbody = document.getElementById('fullHistoryBody');
            const pageInfo = document.getElementById('pageInfo');
            const totalItems = globalTradeHistory.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
            
            tbody.innerHTML = '';
            pageInfo.innerText = `ç¬¬ ${currentPage} / ${totalPages} é  (å…± ${totalItems} ç­†)`;

            let start = (currentPage - 1) * ITEMS_PER_PAGE;
            let end = Math.min(start + ITEMS_PER_PAGE, totalItems);

            for (let i = start; i < end; i++) {
                let row = globalTradeHistory[i];
                let tr = document.createElement('tr');
                
                let numsHtml = row.numbers.map(n => {
                    let className = "num-ball";
                    if (currentMode === 'A') {
                        let is0 = HEADS[0].includes(n);
                        let isP1 = HEADS[row.heads.p1].includes(n);
                        let isP2 = HEADS[row.heads.p2].includes(n);
                        if (is0) className += " num-hit-0";
                        else if (isP1) className += " num-hit-1";
                        else if (isP2 && (row.signal.includes('&'))) className += " num-hit-2";
                    } else {
                        if (row.targets && row.targets.includes(n)) className += " num-hit-1"; 
                    }
                    return `<span class="${className}">${n<10?'0'+n:n}</span>`;
                }).join('');

                let resBadge = row.isWin ? `<span class="res-badge badge-win">WIN</span>` : `<span class="res-badge badge-loss">LOSS</span>`;
                let netColor = row.net > 0 ? "var(--win)" : "var(--loss)";

                tr.innerHTML = `
                    <td style="color:#bdc3c7">${row.date.slice(5)}</td>
                    <td>${numsHtml}</td>
                    <td style="color:var(--gold)">${row.signal}</td>
                    <td>$${row.cost.toLocaleString()}</td>
                    <td style="color:${netColor}; font-weight:bold;">${row.net > 0 ? '+' : ''}$${row.net.toLocaleString()}</td>
                    <td>${resBadge}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function updateEquityChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            let chronoHistory = [...globalTradeHistory].reverse();
            let labels = chronoHistory.map(d => d.date); 
            let data = [];
            let accum = 0;
            
            chronoHistory.forEach(d => {
                accum += d.net;
                data.push(accum);
            });
            
            if (equityChartInstance) {
                equityChartInstance.destroy();
            }
            
            const yearBackgroundPlugin = {
                id: 'yearBackground',
                beforeDraw: (chart) => {
                    const { ctx, chartArea: { top, bottom, height }, scales: { x } } = chart;
                    
                    ctx.save();
                    
                    let currentYear = null;
                    let startX = x.getPixelForValue(0);
                    
                    const bgColors = [
                        'rgba(255, 255, 255, 0.02)', 
                        'rgba(255, 255, 255, 0.08)' 
                    ];
                    
                    const labels = chart.data.labels;
                    
                    const drawSegment = (start, end, year) => {
                        const width = end - start;
                        const colorIndex = parseInt(year) % 2;
                        
                        ctx.fillStyle = bgColors[colorIndex];
                        ctx.fillRect(start, top, width, height);
                        
                        ctx.font = 'bold 60px Arial';
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.08)';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        if (width > 50) { 
                            ctx.fillText(year, start + width / 2, top + height / 2);
                        }
                    };

                    for (let i = 0; i < labels.length; i++) {
                        const year = labels[i].split('/')[0];
                        if (year !== currentYear) {
                            if (currentYear !== null) {
                                const endX = x.getPixelForValue(i); 
                                drawSegment(startX, endX, currentYear);
                                startX = endX;
                            }
                            currentYear = year;
                        }
                    }
                    const finalX = x.getPixelForValue(labels.length - 1);
                    drawSegment(startX, finalX, currentYear);
                    ctx.restore();
                }
            };

            let gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(0, 184, 148, 0.5)'); 
            gradient.addColorStop(1, 'rgba(0, 184, 148, 0)');

            let finalPnl = data.length > 0 ? data[data.length-1] : 0;
            let lineColor = finalPnl >= 0 ? '#00b894' : '#ff7675';

            equityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, 
                    datasets: [{
                        label: 'ç´¯ç©æç›Š (Equity)',
                        data: data,
                        borderColor: lineColor,
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0, 
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (context) => context[0].label,
                                label: function(context) {
                                    return 'ç´¯ç©æç›Š: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }, 
                            ticks: { 
                                color: '#95a5a6', 
                                maxTicksLimit: 12,
                                callback: function(val, index) {
                                    const label = this.getLabelForValue(val);
                                    return label.slice(5); 
                                }
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#bdc3c7' }
                        }
                    }
                },
                plugins: [yearBackgroundPlugin] 
            });
        }

        // ==========================================
        //  FIXED: MISSING FUNCTION RESTORED
        // ==========================================
        function predictNextDraw() {
            let nextDate = getNextDrawDate(fullData[0].date);
            document.getElementById('nextDrawDate').innerText = nextDate.dateStr;
            document.getElementById('nextWeekday').innerText = nextDate.weekdayStr;
            
            if (currentMode === 'A') {
                let past20 = fullData.slice(0, 20);
                let counts = getHeadCounts(past20);
                let others = {1: counts[1], 2: counts[2], 3: counts[3]};
                let sorted = Object.keys(others).sort((a,b) => others[b] - others[a]);
                let p1 = parseInt(sorted[0]);
                let p2 = parseInt(sorted[1]);
                let gap = others[p1] - others[p2];
                let count0 = counts[0];
                let dayIdx = nextDate.dayIdx; 
                
                let signalType = "stop";
                let comboText = "æš«åœä¸‹æ³¨";
                let descText = "æ¿¾ç¶²æœªé";

                let passFilter = false;
                let reason = "";

                if (currentStrategyA === 'sniper_new' || currentStrategyA === 'peak_martingale') {
                    if (dayIdx === 2) reason = "é€±äºŒé¿æˆ°";
                    else if (count0 > 25) reason = "0é ­éç†±(>25)";
                    else passFilter = true;
                } else if (currentStrategyA === 'shield_new') {
                    if (dayIdx === 2 || dayIdx === 3) reason = "é€±äºŒä¸‰é¿æˆ°";
                    else if (count0 > 22) reason = "0é ­éç†±(>22)";
                    else passFilter = true;
                }

                if (passFilter) {
                    if (currentStrategyA === 'peak_martingale') {
                        signalType = "strong"; 
                        comboText = `0+${p1}`;
                        descText = "æ¥µé™å‡¹å–®: ä¾è³‡é‡‘æ°´ä½æ±ºå®šå€æ•¸";
                    } else {
                        if (gap >= 6) { signalType="super"; comboText=`0+${p1} (x2)`; descText="å¼·åŠ›è¨Šè™Ÿ"; }
                        else if (gap <= 2) { signalType="strong"; comboText=`0+${p1} & 0+${p2}`; descText="é›™é¾é˜²ç¦¦"; }
                        else { signalType="weak"; comboText=`0+${p1}`; descText="æ¨™æº–è¨Šè™Ÿ"; }
                    }
                } else {
                    descText = reason;
                }
                
                document.getElementById('pred-combo').innerText = comboText;
                document.getElementById('pred-desc').innerText = descText;
                
                ['btn-super','btn-strong','btn-weak','btn-stop'].forEach(id => document.getElementById(id).classList.remove('active'));
                document.getElementById(`btn-${signalType}`).classList.add('active');

            } else {
                let past15 = fullData.slice(0, 15);
                let numCounts = {};
                for(let k=1; k<=39; k++) numCounts[k] = 0;
                past15.forEach(d => d.numbers.forEach(n => numCounts[n]++));
                
                let sortedNums = Object.keys(numCounts).sort((a,b) => {
                    let diff = numCounts[b] - numCounts[a];
                    if(diff!==0) return diff;
                    return parseInt(a) - parseInt(b);
                });
                
                let top1 = sortedNums[0];
                let top1_c = numCounts[top1];
                let top2 = sortedNums[1];
                let top2_c = numCounts[top2];
                
                document.getElementById('sniper-status').style.display = 'none';
                document.getElementById('sniper-balls-container').style.display = 'flex';
                
                document.getElementById('ball-1').innerText = top1 < 10 ? '0'+top1 : top1;
                document.getElementById('ball-2').innerText = top2 < 10 ? '0'+top2 : top2;
                
                const box = document.querySelector('#panel-mode-b .strategy-box');
                if (top1_c === 6) {
                    box.style.borderColor = "var(--sniper)";
                    box.style.background = "rgba(142, 68, 173, 0.1)";
                    box.innerHTML = `<div style='text-align:center; color:#fff; font-weight:bold;'>ğŸ¯ è¨Šè™Ÿæˆç«‹ (æ¦œé¦–6æ¬¡)<br><span style='font-size:12px; font-weight:normal;'>å»ºè­°ä¸‹æ³¨é€™å…©ç¢¼</span></div>`;
                } else {
                    box.style.borderColor = "#555";
                    box.style.background = "rgba(0,0,0,0.2)";
                    box.innerHTML = `<div style='text-align:center; color:#7f8c8d;'>ğŸ›‘ è¨Šè™Ÿæœªæˆç«‹ (æ¦œé¦–${top1_c}æ¬¡)<br><span style='font-size:12px;'>éœ€å‰›å¥½6æ¬¡æ‰é€²å ´</span></div>`;
                }
            }
        }

        function getHeadCounts(history) {
            let c = {0:0, 1:0, 2:0, 3:0};
            history.forEach(d => d.numbers.forEach(n => {
                if(n<=9) c[0]++; else if(n<=19) c[1]++; else if(n<=29) c[2]++; else c[3]++;
            }));
            return c;
        }

        function checkPrizeA(nums, hA, hB) {
            let hitsA = 0, hitsB = 0, hitsC = 0;
            let setA = HEADS[hA], setB = HEADS[hB];
            nums.forEach(n => {
                if(setA.includes(n)) hitsA++; else if(setB.includes(n)) hitsB++; else hitsC++;
            });
            let sorted = [hitsA, hitsB, hitsC].sort((a,b)=>a-b);
            if(sorted[0]===1 && sorted[1]===2 && sorted[2]===2) return PRIZE_4;
            if(sorted[0]===1 && sorted[1]===1 && sorted[2]===3) return PRIZE_3;
            return 0;
        }

        function getNextDrawDate(lastDateStr) {
            let last = new Date(lastDateStr);
            let next = new Date(last);
            next.setDate(last.getDate() + 1);
            if(next.getDay() === 0) next.setDate(next.getDate() + 1);
            
            let m = (next.getMonth()+1).toString().padStart(2,'0');
            let d = next.getDate().toString().padStart(2,'0');
            let w = "æ—¥ä¸€äºŒä¸‰å››äº”å…­"[next.getDay()];
            return { dateStr: `${m}/${d}`, weekdayStr: `é€±${w}`, dayIdx: next.getDay() };
        }

        function updateStatBox(res) {
            document.getElementById('st-profit').innerText = `$${res.net.toLocaleString()}`;
            document.getElementById('st-profit').className = res.net > 0 ? "stat-value val-win" : "stat-value val-loss";
            let roi = res.cost > 0 ? (res.net / res.cost * 100).toFixed(1) : 0;
            document.getElementById('st-roi').innerText = `${roi}%`;
            
            let winRate = res.tradingDays > 0 ? (res.winDays / res.tradingDays * 100).toFixed(1) : 0;
            document.getElementById('st-winrate').innerText = `${winRate}%`;
            
            document.getElementById('st-count').innerText = res.totalBetUnits || res.tradingDays; 
            document.getElementById('st-max-win').innerText = res.maxWin;
            document.getElementById('st-max-loss').innerText = res.maxLoss;
            document.getElementById('st-mdd').innerText = res.maxDrawdown ? `$${res.maxDrawdown.toLocaleString()}` : '--';
            document.getElementById('real-test-count-disp').innerText = fullData.length;
            document.getElementById('st-unit').innerText = document.getElementById('baseUnit').value;
        }
    </script>
</div>
</body>
</html>
